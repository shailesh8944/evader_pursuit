<!DOCTYPE html>
<html>
<head>
    <title>Odometry Trajectory</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
</head>
<body>
    <div>
        <select id="chartSelect">
            <option value="XY">X-Y Path</option>
            <option value="YZ">Y-Z Path</option>
            <option value="XZ">X-Z Path</option>
            <option value="surge">Surge</option>
            <option value="sway">Sway</option>
            <option value="heave">Heave</option>
            <option value="roll">Roll</option>
            <option value="pitch">Pitch</option>
            <option value="yaw">Yaw</option>
            <option value="surge_vel">Surge Velocity</option>
            <option value="sway_vel">Sway Velocity</option>
            <option value="heave_vel">Heave Velocity</option>
            <option value="roll_vel">Roll Rate</option>
            <option value="pitch_vel">Pitch Rate</option>
            <option value="yaw_vel">Yaw Rate</option>
            <option value="rudder">Rudder Angle</option>
            <option value="propeller">Propeller RPM</option>        
        </select>
    </div>
    <div>
        <style>
        canvas {
            width: auto; /* Set canvas height to auto for aspect ratio preservation */
            height: auto; /* Set canvas width to 80% of container */
            max-width: 800px; /* Limit maximum height to 800px */
            max-height: 800px;
        }
        </style>
        <canvas id="OdometryChart" width="800" height="400"></canvas>
    </div>
    <div>
        <button id="resetButton">Reset</button>
    </div>
    <script>
        function updateChart(selectedChart) {

            if (selectedChart === "rudder" || selectedChart === "propeller") {
                
                fetch('/get_encoders')
                .then(response => response.json())
                .then(data => {
                    
                    if (selectedChart === "rudder") {
                        let t = data.map(i => i.slice(0, 1));
                        let delta = data.map(i => i.slice(1, 2));
                        let xydata = [t, delta];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                        
                    } else if (selectedChart === "propeller") {
                        let t = data.map(i => i.slice(0, 1));
                        let rpm = data.map(i => i.slice(2, 3));
                        let xydata = [t, rpm];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                        
                    } 

                    if (selectedChart != "XY" && selectedChart != "YZ" && selectedChart != "XZ") {
                        let t = data.map(i => i.slice(0, 1));
                        let t_cen = t[t.length - 1]
                        if (t_cen > 10.0) {
                            chart.options.scales.x.min = Math.round(t_cen) - 10; // Update min time to 20 seconds ago
                            chart.options.scales.x.max = Math.round(t_cen) + 10;
                        }                        
                    }
                    chart.data.datasets[0].data = chart_data;
                    chart.update();

                    // var lastPoint = data[data.length - 1];
                    // console.log("Last trajectory point:", lastPoint);
                });

            } else {
                fetch('/get_trajectory')
                .then(response => response.json())
                .then(data => {
                    
                    if (selectedChart === "XY") {
                        
                        let x = data.map(i => i.slice(7, 8));
                        let y = data.map(i => i.slice(8, 9));
                        let xydata = [x, y];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                        chart.options.aspectRatio = 1;
                        
                    } else if (selectedChart === "YZ") {
                        
                        let y = data.map(i => i.slice(8, 9));
                        let z = data.map(i => i.slice(9, 10));
                        let xydata = [y, z];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                        chart.options.aspectRatio = 1;
                        
                    } else if (selectedChart === "XZ") {
                        
                        let x = data.map(i => i.slice(7, 8));
                        let z = data.map(i => i.slice(9, 10));
                        let xydata = [x, z];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                        chart.options.aspectRatio = 1;
                        
                    } else if (selectedChart === "surge_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let u = data.map(i => i.slice(1, 2));
                        let xydata = [t, u];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "sway_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let v = data.map(i => i.slice(2, 3));
                        let xydata = [t, v];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "heave_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let w = data.map(i => i.slice(3, 4));
                        let xydata = [t, w];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "roll_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let p = data.map(i => i.slice(4, 5));
                        let xydata = [t, p];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "pitch_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let q = data.map(i => i.slice(5, 6));
                        let xydata = [t, q];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "yaw_vel") {
                        let t = data.map(i => i.slice(0, 1));
                        let r = data.map(i => i.slice(6, 7));
                        let xydata = [t, r];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "surge") {
                        let t = data.map(i => i.slice(0, 1));
                        let u = data.map(i => i.slice(7, 8));
                        let xydata = [t, u];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "sway") {
                        let t = data.map(i => i.slice(0, 1));
                        let v = data.map(i => i.slice(8, 9));
                        let xydata = [t, v];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "heave") {
                        let t = data.map(i => i.slice(0, 1));
                        let w = data.map(i => i.slice(9, 10));
                        let xydata = [t, w];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "roll") {
                        let t = data.map(i => i.slice(0, 1));
                        let p = data.map(i => i.slice(10, 11));
                        let xydata = [t, p];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "pitch") {
                        let t = data.map(i => i.slice(0, 1));
                        let q = data.map(i => i.slice(11, 12));
                        let xydata = [t, q];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } else if (selectedChart === "yaw") {
                        let t = data.map(i => i.slice(0, 1));
                        let r = data.map(i => i.slice(12, 13));
                        let xydata = [t, r];
                        var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                    } 

                    if (selectedChart != "XY" && selectedChart != "YZ" && selectedChart != "XZ") {
                        let t = data.map(i => i.slice(0, 1));
                        let t_cen = t[t.length - 1]
                        if (t_cen > 10.0) {
                            chart.options.scales.x.min = Math.round(t_cen) - 10; // Update min time to 20 seconds ago
                            chart.options.scales.x.max = Math.round(t_cen) + 10;
                        }                        
                    }

                    chart.data.datasets[0].data = chart_data;
                    chart.update();

                    // var lastPoint = data[data.length - 1];
                    // console.log("Last trajectory point:", lastPoint);
                });
            }            
        }

        function reset() {
            fetch('/reset', { method: 'POST' })
                .then(response => {
                    console.log('Trajectory and encoders variables reset');
                    var selectedChart = document.getElementById('chartSelect').value;

                    if (selectedChart === "XY") {
                        chart.options = xy_options.options;
                    } else {
                        chart.options = ts_options.options;
                    }
                    
                })
                .catch(error => {
                    console.error('Error resetting:', error);
                });
        }
        
        let xy_options = {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Trajectory',
                    borderColor: 'rgb(75, 192, 192)',
                    data: []
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        min: 'auto',
                        max: 'auto'
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        reverse: true,
                        min: 'auto',
                        max: 'auto'
                    }
                },
                pan: {
                    enabled: true,
                    mode: 'x',
                },
                zoom: {
                    enabled: true,
                    mode: 'x',
                }
            }
        }
        
        let ts_options = {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Data',
                    borderColor: 'rgb(75, 192, 192)',
                    data: []
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    },
                    y: {
                        type: 'linear',
                        position: 'left'
                    }
                },
                pan: {
                    enabled: true,
                    mode: 'x',
                },
                zoom: {
                    enabled: true,
                    mode: 'x',
                }
            }
        }

        let ctx = document.getElementById('OdometryChart').getContext('2d');
        let chart = new Chart(ctx, xy_options)
        
        document.getElementById('resetButton').addEventListener('click', function() {
            reset();
        });

        document.getElementById('chartSelect').addEventListener('change', function() {
            var selectedChart = this.value;
            
            if (selectedChart === "XY") {
                chart.options = xy_options.options;
            } else {
                chart.options = ts_options.options;
            }
            
        });

        setInterval(function() {
            var selectedChart = document.getElementById('chartSelect').value;
            updateChart(selectedChart);
        }, 1000);
    </script>
</body>
</html>
