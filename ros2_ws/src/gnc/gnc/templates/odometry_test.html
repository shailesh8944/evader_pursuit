{% extends "template.html" %}

{% block title %}Odometry{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.stlLoader.min.js"></script>
{% endblock %}

{% block content %}
<h1>Odometry Page</h1>
<p>Below is a 3D visualization of the vehicle:</p>

<div id="3d-chart" style="width: 100%; height: 600px;"></div>

<script>
    // Basic Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('3d-chart').appendChild(renderer.domElement);

    // Set origin at water surface (y = 0)
    const waterSurface = 0;

    // Add water surface
    const waterGeometry = new THREE.PlaneGeometry(1000, 1000);
    const waterMaterial = new THREE.MeshPhongMaterial({ color: 0x3399ff, opacity: 0.7, transparent: true });
    const water = new THREE.Mesh(waterGeometry, waterMaterial);
    water.rotation.x = -Math.PI / 2;
    water.position.y = waterSurface;
    scene.add(water);

    // Add seabed below water surface
    const seabedGeometry = new THREE.PlaneGeometry(1000, 1000);
    const seabedMaterial = new THREE.MeshBasicMaterial({ color: 0x70543e });
    const seabed = new THREE.Mesh(seabedGeometry, seabedMaterial);
    seabed.rotation.x = -Math.PI / 2;
    seabed.position.y = waterSurface - 100; // Seabed is positioned 100 units below the water surface
    scene.add(seabed);

    // Import the vehicle STL file
    const stlLoader = new THREE.STLLoader();
    let vehicleMesh;
    stlLoader.load('/path/to/vehicle_model.stl', (geometry) => {
        const material = new THREE.MeshPhongMaterial({ color: 0x555555, specular: 0x111111, shininess: 100 });
        vehicleMesh = new THREE.Mesh(geometry, material);
        
        // Set initial vehicle position (can be adjusted)
        vehicleMesh.position.set(0, waterSurface - 2, 0);  // Slightly below water surface
        vehicleMesh.scale.set(0.1, 0.1, 0.1); // Adjust scale if necessary
        scene.add(vehicleMesh);
    });

    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040); // Soft white light
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight.position.set(1, 1, 1).normalize();
    scene.add(directionalLight);

    camera.position.set(10, 10, 20);
    camera.lookAt(0, 0, 0);

    // Fetch trajectory data and update vehicle position
    async function fetchState() {
        const response = await fetch('/get_state');
        const data = await response.json();
        let t = data.map(i => i.slice(0, 1));
        let x = data.map(i => i.slice(7, 8));
        let y = data.map(i => i.slice(8, 9));
        let z = data.map(i => i.slice(9, 10));
        let phi = data.map(i => i.slice(10, 11));
        let theta = data.map(i => i.slice(11, 12));
        let psi = data.map(i => i.slice(12, 13));
        
        let index = 0;
        function animate() {
            if (vehicleMesh && x && y && z && phi && theta && psi) {                
                vehicleMesh.position.set(x, y, z);
                index = (index + 1);
            }
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
        animate();
    }
    fetchState();
</script>
{% endblock %}
