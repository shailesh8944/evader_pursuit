{% extends "template.html" %}

{% block title %}Mission{% endblock %}

{% block extra_head %}
<script>
    // Function to fetch currently launched packages
    function fetchActiveLaunches() {
        fetch('/active_launches')
            .then(response => response.json())
            .then(data => {
                const activeLaunchesDiv = document.getElementById('active-launches');
                activeLaunchesDiv.innerHTML = ''; // Clear the existing list

                if (data.length === 0) {
                    activeLaunchesDiv.innerHTML = '<p>No active launches</p>';
                    return;
                }

                // Display each active launch with a "Reset" and "Stop" button
                data.forEach(launch => {
                    const launchItem = document.createElement('div');
                    launchItem.className = 'launch-item'; // Specify the class name
                    launchItem.innerHTML = `
                        <p>${launch.package} - ${launch.launch_file} (PID: ${launch.pid})</p>
                        <button style="display: inline-block; margin-left: 10px;" onclick="resetLaunch('${launch.package}', '${launch.launch_file}')">Reset</button>
                        <button style="display: inline-block; margin-left: 10px;" onclick="stopLaunch('${launch.package}', '${launch.launch_file}')">Stop</button>
                    `;
                    activeLaunchesDiv.appendChild(launchItem);
                });                
            })
            .catch(error => console.error('Error fetching active launches:', error));
    }

    // Function to start selected ROS 2 packages
    function startRos2() {
        const checkboxes = document.querySelectorAll('input[name="package_launch"]:checked');
        const selectedPackages = Array.from(checkboxes).map(cb => cb.value);

        if (selectedPackages.length === 0) {
            alert('Please select at least one package to launch.');
            return;
        }

        fetch('/start_ros2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ package_launch: selectedPackages })
        })
        .then(response => response.json())
        .then(data => {
            let message = '';
            data.forEach(item => {
                if (item.error) {
                    errorMessages += item.error + '\n';
                }
            });
            // alert(message);
            if (errorMessages) {
                alert(errorMessages); // Show errors if any
            }
            
            // fetchActiveLaunches(); // Refresh the list of active launches
            setTimeout(fetchActiveLaunches, 200);
        })
        .catch(error => console.error('Error starting launches:', error));
    }

    // Function to reset a launch
    function resetLaunch(packageName, launchFile) {
        fetch('/reset_ros2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ package: packageName, launch_file: launchFile })
        })
        .then(response => response.json())
        .then(data => {
            // alert(data.message || data.error);
            if (data.error) {
                alert(data.error); // Show error if any
            }
            fetchActiveLaunches(); // Refresh the list of active launches
        })
        .catch(error => console.error('Error resetting launch:', error));
    }

    // Function to stop a launch
    function stopLaunch(packageName, launchFile) {
        fetch('/stop_ros2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ package: packageName, launch_file: launchFile })
        })
        .then(response => response.json())
        .then(data => {
            // alert(data.message || data.error);
            if (data.error) {
                alert(data.error); // Show error if any
            }
            fetchActiveLaunches(); // Refresh the list of active launches
        })
        .catch(error => console.error('Error stopping launch:', error));
    }

    // Fetch the active launches when the page loads
    window.onload = fetchActiveLaunches;
</script>
{% endblock %}

{% block content %}
<h1>Mission Page</h1>
<!-- <p>Select the packages to launch</p> -->
<div class="centered-div-flex">
    <h3>Select the packages to launch</h3>    
</div>

<div class="centered-div-flex" id="ros2-checkboxes">
    <form onsubmit="event.preventDefault(); startRos2();">
        <!-- <label>Available ROS 2 Packages to Launch:</label><br> -->
        <input type="checkbox" name="package_launch" value="sbg_driver:sbg_device_launch.py"> SBG <br>
        <input type="checkbox" name="package_launch" value="ublox_gps:ublox_device_node-launch.py"> Ardusimple <br>
        <input type="checkbox" name="package_launch" value="gnc:gnc_launch.py"> GNC<br>
        <!-- <input type="checkbox" name="package_launch" value="package3:launch3.launch.py"> Package 3 - Launch 3<br> -->
        <!-- Add more package-launch combinations as needed -->
        <br>
        <button type="submit">Launch ROS2 Packages</button>
    </form>
</div>
<br>
<div class="centered-div-flex">
    <h3>Currently Launched Packages </h3>
    <button style="display: inline-block; margin-left: 10px;" onclick="fetchActiveLaunches()">Refresh</button>
</div>
<div class="centered-div-flex" id="active-launches">
    <!-- Active launches will be dynamically populated here -->
</div>
<br>
<!-- <form action="/stop_ros2" method="POST">
    <label for="stop_package_launch">Stop ROS 2 Package:</label><br>
    <input type="text" id="stop_package_launch" name="package_launch" placeholder="package:launch_file" required>
    <button type="submit">Stop</button>
</form> -->

{% endblock %}
