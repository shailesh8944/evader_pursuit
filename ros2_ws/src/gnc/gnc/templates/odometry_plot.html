{% extends "template.html" %}

{% block title %}Odometry Plots{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
{% endblock %}

{% block content %}
<h1>Odometry Plots Page</h1>
<p>This is the Odometry Plots page. You can add content related to the odometry plots here.</p>

<div class="my_div">
    <select id="odomTopicSelect">
    </select>
    <select id="encTopicSelect">
    </select>
    <button style="display: inline-block; margin-left: 10px;" onclick="fetchOdomEncTopics()">Refresh Topics</button>
</div>

<div class="my_div">
    <select id="chartSelect">
        <option value="XY">X-Y Path</option>
        <option value="YZ">Y-Z Path</option>
        <option value="XZ">X-Z Path</option>
        <option value="surge">Surge</option>
        <option value="sway">Sway</option>
        <option value="heave">Heave</option>
        <option value="roll">Roll</option>
        <option value="pitch">Pitch</option>
        <option value="yaw">Yaw</option>
        <option value="surge_vel">Surge Velocity</option>
        <option value="sway_vel">Sway Velocity</option>
        <option value="heave_vel">Heave Velocity</option>
        <option value="roll_vel">Roll Rate</option>
        <option value="pitch_vel">Pitch Rate</option>
        <option value="yaw_vel">Yaw Rate</option>
        <option value="rudder">Rudder Angle</option>
        <option value="propeller">Propeller RPM</option>        
    </select>
    <button id="resetButton">Reset</button>
</div>

<!-- Flexbox example -->
<div class="centered-div-flex">
    <div class="centered-div-chart">
        <canvas id="OdometryChart" style="justify-content: center;"></canvas>
    </div>
</div>

<!-- Grid example
<div class="centered-div-grid">
    <div class="centered-div">
        <canvas id="OdometryChart" style="justify-content: center;"></canvas>
    </div>
</div> -->

<script>
    async function fetchOdomEncTopics() {
        try {
            const odom_response = await fetch('/get_odometry_topics');
            const enc_response = await fetch('/get_encoder_topics');

            if (!odom_response.ok || !enc_response.ok) {
                throw new Error('Network response was not ok');
            }

            let odom_topics_of_topics = await odom_response.json();
            let odom_topics = odom_topics_of_topics.topics;

            let enc_topics_of_topics = await enc_response.json();
            let enc_topics = enc_topics_of_topics.topics;

            const odomTopicSelect = document.getElementById('odomTopicSelect');
            const encTopicSelect = document.getElementById('encTopicSelect');

            // Clear existing options
            odomTopicSelect.innerHTML = '';
            encTopicSelect.innerHTML = '';

            // Populate odometry topics
            odom_topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic; // Set the value of the option
                option.textContent = topic; // Set the displayed text
                odomTopicSelect.appendChild(option); // Add the option to the select
            });

            // Populate encoder topics
            enc_topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic; // Set the value of the option
                option.textContent = topic; // Set the displayed text
                encTopicSelect.appendChild(option); // Add the option to the select
            });
        } catch (error) {
            console.error('Error fetching topics:', error);
        }
    }

    function updateChart(selectedChart) {

        // Sample JSON object
        const odom_params = {
            topic: document.getElementById('odomTopicSelect').value
        };

        const enc_params = {
            topic: document.getElementById('encTopicSelect').value
        };

        // Convert JSON object to query string
        const odom_queryString = new URLSearchParams(odom_params).toString();
        const enc_queryString = new URLSearchParams(enc_params).toString();

        // Create the full URL
        const odom_url = `/get_trajectory?${odom_queryString}`;
        const enc_url = `/get_encoders?${enc_queryString}`;

        if (selectedChart === "rudder" || selectedChart === "propeller") {
            
            fetch(enc_url)
            .then(response => response.json())
            .then(data => {
                
                if (selectedChart === "rudder") {
                    let t = data.map(i => i.slice(0, 1));
                    let delta = data.map(i => i.slice(1, 2));
                    let xydata = [t, delta];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                    
                } else if (selectedChart === "propeller") {
                    let t = data.map(i => i.slice(0, 1));
                    let rpm = data.map(i => i.slice(2, 3));
                    let xydata = [t, rpm];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                    
                } 

                if (selectedChart != "XY" && selectedChart != "YZ" && selectedChart != "XZ") {
                    let t = data.map(i => i.slice(0, 1));
                    let t_cen = t[t.length - 1]
                    if (t_cen > 10.0) {
                        chart.options.scales.x.min = Math.round(t_cen) - 10; // Update min time to 20 seconds ago
                        chart.options.scales.x.max = Math.round(t_cen) + 10;
                    }                        
                }
                chart.data.datasets[0].data = chart_data;
                chart.update();

                // var lastPoint = data[data.length - 1];
                // console.log("Last trajectory point:", lastPoint);
            });

        } else {
            fetch(odom_url)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                
                if (selectedChart === "XY") {
                    
                    let x = data.map(i => i.slice(7, 8));
                    let y = data.map(i => i.slice(8, 9));
                    let xydata = [x, y];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                    chart.options.aspectRatio = 1;
                    
                } else if (selectedChart === "YZ") {
                    
                    let y = data.map(i => i.slice(8, 9));
                    let z = data.map(i => i.slice(9, 10));
                    let xydata = [y, z];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                    chart.options.aspectRatio = 1;
                    
                } else if (selectedChart === "XZ") {
                    
                    let x = data.map(i => i.slice(7, 8));
                    let z = data.map(i => i.slice(9, 10));
                    let xydata = [x, z];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));
                    chart.options.aspectRatio = 1;
                    
                } else if (selectedChart === "surge_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let u = data.map(i => i.slice(1, 2));
                    let xydata = [t, u];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "sway_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let v = data.map(i => i.slice(2, 3));
                    let xydata = [t, v];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "heave_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let w = data.map(i => i.slice(3, 4));
                    let xydata = [t, w];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "roll_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let p = data.map(i => i.slice(4, 5));
                    let xydata = [t, p];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "pitch_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let q = data.map(i => i.slice(5, 6));
                    let xydata = [t, q];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "yaw_vel") {
                    let t = data.map(i => i.slice(0, 1));
                    let r = data.map(i => i.slice(6, 7));
                    let xydata = [t, r];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "surge") {
                    let t = data.map(i => i.slice(0, 1));
                    let u = data.map(i => i.slice(7, 8));
                    let xydata = [t, u];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "sway") {
                    let t = data.map(i => i.slice(0, 1));
                    let v = data.map(i => i.slice(8, 9));
                    let xydata = [t, v];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "heave") {
                    let t = data.map(i => i.slice(0, 1));
                    let w = data.map(i => i.slice(9, 10));
                    let xydata = [t, w];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "roll") {
                    let t = data.map(i => i.slice(0, 1));
                    let p = data.map(i => i.slice(10, 11));
                    let xydata = [t, p];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "pitch") {
                    let t = data.map(i => i.slice(0, 1));
                    let q = data.map(i => i.slice(11, 12));
                    let xydata = [t, q];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } else if (selectedChart === "yaw") {
                    let t = data.map(i => i.slice(0, 1));
                    let r = data.map(i => i.slice(12, 13));
                    let xydata = [t, r];
                    var chart_data = xydata[0].map((_, colIndex) => xydata.map(row => row[colIndex]));

                } 

                if (selectedChart != "XY" && selectedChart != "YZ" && selectedChart != "XZ") {
                    let t = data.map(i => i.slice(0, 1));
                    let t_cen = t[t.length - 1]
                    if (t_cen > 10.0) {
                        chart.options.scales.x.min = Math.round(t_cen) - 10; // Update min time to 20 seconds ago
                        chart.options.scales.x.max = Math.round(t_cen) + 10;
                    }                        
                }

                chart.data.datasets[0].data = chart_data;
                chart.update();

                // var lastPoint = data[data.length - 1];
                // console.log("Last trajectory point:", lastPoint);
            });
        }            
    }

    function reset() {
        fetch('/reset', { method: 'POST' })
            .then(response => {
                console.log('Trajectory and encoders variables reset');
                var selectedChart = document.getElementById('chartSelect').value;

                if (selectedChart === "XY") {
                    chart.options = xy_options.options;
                } else {
                    chart.options = ts_options.options;
                }
                
            })
            .catch(error => {
                console.error('Error resetting:', error);
            });
    }
    
    let xy_options = {
        type: 'line',
        data: {
            datasets: [{
                label: 'Trajectory',
                borderColor: 'rgb(75, 192, 192)',
                data: []
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    min: 'auto',
                    max: 'auto'
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    reverse: true,
                    min: 'auto',
                    max: 'auto'
                }
            },
            pan: {
                enabled: true,
                mode: 'x',
            },
            zoom: {
                enabled: true,
                mode: 'x',
            }
        }
    }
    
    let ts_options = {
        type: 'line',
        data: {
            datasets: [{
                label: 'Data',
                borderColor: 'rgb(75, 192, 192)',
                data: []
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom'
                },
                y: {
                    type: 'linear',
                    position: 'left'
                }
            },
            pan: {
                enabled: true,
                mode: 'x',
            },
            zoom: {
                enabled: true,
                mode: 'x',
            }
        }
    }

    let ctx = document.getElementById('OdometryChart').getContext('2d');
    let chart = new Chart(ctx, xy_options)
    
    document.getElementById('resetButton').addEventListener('click', function() {
        reset();
    });

    document.getElementById('chartSelect').addEventListener('change', function() {
        var selectedChart = this.value;
        
        if (selectedChart === "XY") {
            chart.options = xy_options.options;
        } else {
            chart.options = ts_options.options;
        }
        
    });

    fetchOdomEncTopics();

    setInterval(function() {
        var selectedChart = document.getElementById('chartSelect').value;
        updateChart(selectedChart);        
    }, 1000);

</script>

{% endblock %}
