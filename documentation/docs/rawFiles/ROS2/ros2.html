<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ROS2 Architecture – Pani Simulator</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../rawFiles/WebConfigurator/web_configurator.html" rel="next">
<link href="../../rawFiles/Inputs/inputs.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-de84f8d6bb715db06a919283c2d1e787.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-9a023c9ade86a60361e96e3e3f11bc54.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-7db324b88d23813ba50d10228a5600f6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-4a1d4c259b44775fcef54614c9851e3a.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../rawFiles/ROS2/ros2.html">ROS2 Architecture</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Pani Simulator</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/goldenrishabh/panisim" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pani Simulator</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/quickstart.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quickstart</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/Kinematics/Kinematics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kinematics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/Dynamics/Dynamics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dynamics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/Navigation/sensors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sensors Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/Inputs/inputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simualtion Inputs</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/ROS2/ros2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">ROS2 Architecture</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../rawFiles/WebConfigurator/web_configurator.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vessel Configurator</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#architecture" id="toc-architecture" class="nav-link" data-scroll-target="#architecture">Architecture</a></li>
  <li><a href="#key-components" id="toc-key-components" class="nav-link" data-scroll-target="#key-components">Key Components</a>
  <ul class="collapse">
  <li><a href="#main-simulation-script-simulate.py" id="toc-main-simulation-script-simulate.py" class="nav-link" data-scroll-target="#main-simulation-script-simulate.py">Main Simulation Script (<code>simulate.py</code>)</a></li>
  <li><a href="#world-class-class_world.py" id="toc-world-class-class_world.py" class="nav-link" data-scroll-target="#world-class-class_world.py">World Class (<code>class_world.py</code>)</a></li>
  <li><a href="#world_node-class-class_world_node_ros2.py" id="toc-world_node-class-class_world_node_ros2.py" class="nav-link" data-scroll-target="#world_node-class-class_world_node_ros2.py">World_Node Class (<code>class_world_node_ros2.py</code>)</a></li>
  <li><a href="#vessel_pub_sub-class-class_vessel_pub_sub_ros2.py" id="toc-vessel_pub_sub-class-class_vessel_pub_sub_ros2.py" class="nav-link" data-scroll-target="#vessel_pub_sub-class-class_vessel_pub_sub_ros2.py">Vessel_Pub_Sub Class (<code>class_vessel_pub_sub_ros2.py</code>)</a></li>
  </ul></li>
  <li><a href="#message-flow" id="toc-message-flow" class="nav-link" data-scroll-target="#message-flow">Message Flow</a></li>
  <li><a href="#topics-and-messages" id="toc-topics-and-messages" class="nav-link" data-scroll-target="#topics-and-messages">Topics and Messages</a>
  <ul class="collapse">
  <li><a href="#standard-topics" id="toc-standard-topics" class="nav-link" data-scroll-target="#standard-topics">Standard Topics</a></li>
  <li><a href="#sensor-topics" id="toc-sensor-topics" class="nav-link" data-scroll-target="#sensor-topics">Sensor Topics</a></li>
  </ul></li>
  <li><a href="#sensor-integration" id="toc-sensor-integration" class="nav-link" data-scroll-target="#sensor-integration">Sensor Integration</a></li>
  <li><a href="#actuator-control" id="toc-actuator-control" class="nav-link" data-scroll-target="#actuator-control">Actuator Control</a>
  <ul class="collapse">
  <li><a href="#actuator-message-structure-actuator.msg" id="toc-actuator-message-structure-actuator.msg" class="nav-link" data-scroll-target="#actuator-message-structure-actuator.msg">Actuator Message Structure (<code>Actuator.msg</code>)</a></li>
  </ul></li>
  <li><a href="#world-and-vessel-population" id="toc-world-and-vessel-population" class="nav-link" data-scroll-target="#world-and-vessel-population">World and Vessel Population</a></li>
  <li><a href="#running-the-simulation" id="toc-running-the-simulation" class="nav-link" data-scroll-target="#running-the-simulation">Running the Simulation</a></li>
  <li><a href="#best-practices" id="toc-best-practices" class="nav-link" data-scroll-target="#best-practices">Best Practices</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/goldenrishabh/panisim/edit/main/rawFiles/ROS2/ros2.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/goldenrishabh/panisim/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">ROS2 Architecture</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>The Panisim runs on the Robot Operating System 2 (ROS2), enabling distributed simulation, external control, visualization, and data recording. The ROS2 integration architecture follows a modular design pattern that separates the simulation core from the communication layer. The Docker container of the simlator runs ROS2 Humble.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The ROS2 integration allows the Panisim to run completely isolated from controllers or guidance systems, thus enabling you to code your own controllers or guidance systems to interact with the simulator.</p>
</div>
</div>
</section>
<section id="architecture" class="level2">
<h2 class="anchored" data-anchor-id="architecture">Architecture</h2>
<p>The ROS2 integration consists of several key components that work together to bridge the simulation with the ROS2 ecosystem:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%
flowchart TB
    subgraph Simulation["Simulation Core"]
        World["World Class&lt;br&gt;(class_world.py)"]
        Vessel["Vessel Class&lt;br&gt;(class_vessel.py)"]
        Vessel2["Vessel Class&lt;br&gt;(Additional Vessels)"]
        World --&gt; Vessel
        World --&gt; Vessel2
    end

    subgraph ROS2["ROS2 Integration"]
        World_Node["World_Node&lt;br&gt;(class_world_node_ros2.py)"]
        Vessel_Pub_Sub["Vessel_Pub_Sub&lt;br&gt;(class_vessel_pub_sub_ros2.py)"]
        Vessel_Pub_Sub2["Vessel_Pub_Sub&lt;br&gt;(Additional Vessels)"]
    end

    subgraph Applications["ROS2 Ecosystem"]
        Controllers["External Controllers"]
        Visualization["Visualization Tools&lt;br&gt;(RViz, Foxglove)"]
        Logging["Data Logging"]
        Other["Other ROS2 Nodes"]
    end

    Main["Main Simulation Script&lt;br&gt;(simulate.py)"] --&gt; World
    Main --&gt; World_Node
    World_Node --&gt; World
    Vessel --&gt; Vessel_Pub_Sub
    Vessel2 --&gt; Vessel_Pub_Sub2
    Vessel_Pub_Sub --&gt; Controllers
    Vessel_Pub_Sub --&gt; Visualization
    Vessel_Pub_Sub --&gt; Logging
    Vessel_Pub_Sub --&gt; Other
    Vessel_Pub_Sub2 --&gt; Controllers
    Vessel_Pub_Sub2 --&gt; Visualization
    Vessel_Pub_Sub2 --&gt; Logging
    Vessel_Pub_Sub2 --&gt; Other
    World_Node --- Vessel_Pub_Sub
    World_Node --- Vessel_Pub_Sub2

    classDef core fill:#5D8AA8,stroke:#1F456E,color:white;
    classDef ros2 fill:#6B8E23,stroke:#2E3B0F,color:white;
    classDef app fill:#966FD6,stroke:#4A357A,color:white;
    classDef main fill:#FF6347,stroke:#8B3626,color:white;

    class World,Vessel,Vessel2 core;
    class World_Node,Vessel_Pub_Sub,Vessel_Pub_Sub2 ros2;
    class Controllers,Visualization,Logging,Other app;
    class Main main;
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Explanation of the Architecture Flow:</strong></p>
<ul>
<li><strong>Main Simulation Script (<code>simulate.py</code>)</strong>: Initiates the simulation by:
<ul>
<li>Calling <code>rclpy.init()</code> to initialize the ROS2 middleware</li>
<li>Creating a <code>World</code> instance by calling <code>World(config_file_path)</code></li>
<li>Instantiating a <code>World_Node</code> that wraps the simulation in ROS2</li>
<li>Calling <code>world.start_vessel_ros_nodes(world_node)</code> to connect vessels to ROS2</li>
</ul></li>
<li><strong>World Class (<code>class_world.py</code>)</strong>:
<ul>
<li>Maintains multiple vessel instances using <code>vessels = []</code></li>
<li>Processes world input with <code>process_world_input(world_file)</code></li>
<li>Creates vessels via <code>Vessel(vessel_params, hydrodynamic_data, vessel_id)</code></li>
<li>Updates simulation state with <code>step()</code> method that calls <code>vessel.step()</code> for each vessel</li>
</ul></li>
<li><strong>World_Node Class (<code>class_world_node_ros2.py</code>)</strong>:
<ul>
<li>Inherits from ROS2 <code>Node</code> class</li>
<li>Creates a timer with <code>create_timer(1/self.rate, self.world.step)</code> to drive simulation</li>
</ul></li>
<li><strong>Vessel_Pub_Sub Class (<code>class_vessel_pub_sub_ros2.py</code>)</strong>:
<ul>
<li>Creates publishers, subscribers, and timers for each vessel</li>
<li>Publishes vessel state and sensor data</li>
<li>Handles actuator commands via subscribers</li>
</ul></li>
</ul>
</section>
<section id="key-components" class="level2">
<h2 class="anchored" data-anchor-id="key-components">Key Components</h2>
<section id="main-simulation-script-simulate.py" class="level3">
<h3 class="anchored" data-anchor-id="main-simulation-script-simulate.py">Main Simulation Script (<code>simulate.py</code>)</h3>
<p>The entry point for running Panisim with ROS2 integration. This script:</p>
<ol type="1">
<li>Initializes the ROS2 environment</li>
<li>Creates the World simulation instance</li>
<li>Sets up the World_Node for ROS2 communication</li>
<li>Establishes connections between simulation and ROS2</li>
<li>Runs the ROS2 spin loop in a separate thread</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creates an object of class 'World'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    rclpy.init()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    world <span class="op">=</span> World(<span class="st">'/workspaces/mavlab/inputs/simulation_input.yml'</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    world_node <span class="op">=</span> World_Node(world_rate<span class="op">=</span><span class="dv">1</span><span class="op">/</span>world.dt)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    world.node <span class="op">=</span> world_node</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    world.start_vessel_ros_nodes(world_node)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run ROS on a separate thread</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    ros_thread_instance <span class="op">=</span> threading.Thread(target<span class="op">=</span>ros_thread, args<span class="op">=</span>(world_node,))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    ros_thread_instance.start()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prints available ROS2 topics and usage information</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>ros_thread</code> function is defined as:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ros_thread(node):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    rclpy.spin(node)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    rclpy.shutdown()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function handles the ROS2 event loop, allowing callbacks to be processed in the background while the main thread can perform other tasks.</p>
</section>
<section id="world-class-class_world.py" class="level3">
<h3 class="anchored" data-anchor-id="world-class-class_world.py">World Class (<code>class_world.py</code>)</h3>
<p>The World class serves as the simulation environment container, managing:</p>
<ul>
<li>Multiple vessel instances within a unified simulation</li>
<li>Initialization from configuration files</li>
<li>Simulation time stepping across all vessels</li>
<li>Global parameters like GPS datum and world boundaries</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> World():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    terminate <span class="op">=</span> <span class="va">False</span>                   <span class="co"># Flag indicating simulation termination</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    vessels <span class="op">=</span> []                        <span class="co"># List of Vessel objects</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    nvessels <span class="op">=</span> <span class="dv">0</span>                        <span class="co"># Number of vessels</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    size <span class="op">=</span> np.zeros(<span class="dv">3</span>)                  <span class="co"># Size of the world (X-Y-Z)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    gps_datum <span class="op">=</span> <span class="va">None</span>                    <span class="co"># GPS reference point</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> <span class="va">None</span>                         <span class="co"># ROS2 node reference</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> <span class="fl">0.01</span>                           <span class="co"># Simulation time step</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize the World object from configuration file"""</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> world_file <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.process_world_input(world_file)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>):</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Advance the simulation by one time step"""</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> vessel <span class="kw">in</span> <span class="va">self</span>.vessels:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            vessel.step()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>process_world_input</code> method reads the simulation configuration from YAML files:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_world_input(<span class="va">self</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        sim_params, agents <span class="op">=</span> read_input(world_file)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> np.array(sim_params[<span class="st">'world_size'</span>])</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nvessels <span class="op">=</span> sim_params[<span class="st">'nagents'</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gps_datum <span class="op">=</span> np.array(sim_params[<span class="st">'gps_datum'</span>])</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        agent_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dt <span class="op">=</span> sim_params[<span class="st">'time_step'</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> agent <span class="kw">in</span> agents[<span class="dv">0</span>:<span class="va">self</span>.nvessels]:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            vessel_config <span class="op">=</span> agent[<span class="st">'vessel_config'</span>]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            hydrodynamic_data <span class="op">=</span> agent[<span class="st">'hydrodynamics'</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vessels.append(Vessel(vessel_params<span class="op">=</span>vessel_config, </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                      hydrodynamic_data<span class="op">=</span>hydrodynamic_data, </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                      vessel_id<span class="op">=</span>agent_count))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            agent_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> yaml.YAMLError <span class="im">as</span> exc:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(exc)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        exit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The World class includes a method to start the ROS2 nodes for all vessels:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_vessel_ros_nodes(<span class="va">self</span>, world_node):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Initialize ROS2 nodes for all vessels in the world"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> vessel <span class="kw">in</span> <span class="va">self</span>.vessels:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        vessel.vessel_node <span class="op">=</span> Vessel_Pub_Sub(vessel, world_node)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="world_node-class-class_world_node_ros2.py" class="level3">
<h3 class="anchored" data-anchor-id="world_node-class-class_world_node_ros2.py">World_Node Class (<code>class_world_node_ros2.py</code>)</h3>
<p>The World_Node class is a ROS2 node wrapper for the World class:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> World_Node(Node):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, world_rate<span class="op">=</span><span class="dv">100</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">'world'</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rate <span class="op">=</span> world_rate</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world <span class="op">=</span> World(world_file)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.create_timer(<span class="dv">1</span><span class="op">/</span><span class="va">self</span>.rate, callback<span class="op">=</span><span class="va">self</span>.world.step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This class: - Inherits from the ROS2 Node class - Creates a timer that triggers the simulation step function at a specified rate - Provides the ROS2 context for the World class</p>
<p>The <code>create_timer</code> method sets up a timer that calls the <code>World.step()</code> method at regular intervals determined by <code>world_rate</code>. This is what drives the simulation forward in time while maintaining synchronization with the ROS2 ecosystem.</p>
</section>
<section id="vessel_pub_sub-class-class_vessel_pub_sub_ros2.py" class="level3">
<h3 class="anchored" data-anchor-id="vessel_pub_sub-class-class_vessel_pub_sub_ros2.py">Vessel_Pub_Sub Class (<code>class_vessel_pub_sub_ros2.py</code>)</h3>
<p>The Vessel_Pub_Sub class implements the ROS2 communication interface for vessel objects:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vessel_Pub_Sub():</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vessel, world_node):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize the vessel interface"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world_node <span class="op">=</span> world_node</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel <span class="op">=</span> vessel</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel_id <span class="op">=</span> vessel.vessel_id</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel_name <span class="op">=</span> vessel.vessel_name</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.topic_prefix <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>vessel_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>vessel_id<span class="sc">:02d}</span><span class="ss">'</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize publishers, subscribers, and timers</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This class:</p>
<ul>
<li>Creates and manages ROS2 publishers for vessel state and sensor data</li>
<li>Sets up subscribers for actuator commands</li>
<li>Handles message conversion between simulator data and ROS2 messages</li>
<li>Manages sensor data publication at appropriate rates</li>
</ul>
<p>Key initialization methods include:</p>
<ul>
<li>Setting up control surface and thruster mappings</li>
<li>Creating sensor objects and their publishers</li>
<li>Initializing odometry and vessel state publishers</li>
<li>Creating actuator command subscribers</li>
</ul>
</section>
</section>
<section id="message-flow" class="level2">
<h2 class="anchored" data-anchor-id="message-flow">Message Flow</h2>
<p>The communication between simulation components and the ROS2 ecosystem follows this message flow:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%
sequenceDiagram
    participant S as Simulation
    participant VP as Vessel_Pub_Sub
    participant R as ROS2 Network
    participant E as External Nodes

    S-&gt;&gt;VP: Vessel state update
    S-&gt;&gt;VP: Sensor data
    
    VP-&gt;&gt;R: Publish odometry
    VP-&gt;&gt;R: Publish vessel state
    VP-&gt;&gt;R: Publish sensor data (IMU, GPS, etc.)
    
    E-&gt;&gt;R: Subscribe to vessel data
    E-&gt;&gt;R: Process and visualize
    
    E-&gt;&gt;R: Publish control commands
    R-&gt;&gt;VP: Actuator commands
    VP-&gt;&gt;S: Update vessel actuators
    
    Note over S,VP: Simulation Step
    S-&gt;&gt;S: Advance simulation
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Detailed Function Call Sequence:</strong></p>
<ol type="1">
<li><strong>Vessel State Update</strong>:
<ul>
<li><code>vessel.step()</code> in <code>World.step()</code> updates the vessel state</li>
<li>This updates <code>vessel.current_state</code>, which is accessed by publishers</li>
</ul></li>
<li><strong>Sensor Data Generation</strong>:
<ul>
<li>Sensor objects call <code>get_measurement()</code> to generate simulated sensor readings based on vessel state</li>
</ul></li>
<li><strong>Publishing Data to ROS2</strong>:
<ul>
<li><code>publish_odometry()</code> is called by a timer to publish vessel position and orientation</li>
<li><code>publish_vessel_state()</code> is called by a timer to publish complete state vector</li>
<li><code>_publish_sensor()</code> is called by sensor-specific timers to publish sensor data</li>
</ul></li>
<li><strong>External Nodes Subscribing</strong>:
<ul>
<li>External ROS2 nodes subscribe to topics using <code>ros2 topic echo</code> or programmatically</li>
</ul></li>
<li><strong>Control Commands</strong>:
<ul>
<li>External nodes publish to <code>/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd</code></li>
<li><code>actuator_callback(msg)</code> processes these commands</li>
</ul></li>
<li><strong>Updating Actuator States</strong>:
<ul>
<li><code>vessel.delta_c</code> (control surfaces) and <code>vessel.n_c</code> (thrusters) are updated</li>
<li>These affect the vessel dynamics in the next simulation step</li>
</ul></li>
<li><strong>Simulation Step</strong>:
<ul>
<li>The timer in <code>World_Node</code> triggers <code>world.step()</code></li>
<li>This advances all vessels’ states using their dynamics models</li>
</ul></li>
</ol>
</section>
<section id="topics-and-messages" class="level2">
<h2 class="anchored" data-anchor-id="topics-and-messages">Topics and Messages</h2>
<p>Each vessel in the simulation publishes data on several ROS2 topics:</p>
<section id="standard-topics" class="level3">
<h3 class="anchored" data-anchor-id="standard-topics">Standard Topics</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 41%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th>Topic</th>
<th>Message Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/odometry_sim</code></td>
<td><code>nav_msgs/Odometry</code></td>
<td>Vessel position, orientation, and velocities</td>
</tr>
<tr class="even">
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/vessel_state</code></td>
<td><code>std_msgs/Float64MultiArray</code></td>
<td>Complete vessel state including actuators</td>
</tr>
<tr class="odd">
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd</code></td>
<td><code>interfaces/Actuator</code></td>
<td>Commands for control surfaces and thrusters</td>
</tr>
</tbody>
</table>
</section>
<section id="sensor-topics" class="level3">
<h3 class="anchored" data-anchor-id="sensor-topics">Sensor Topics</h3>
<p>Each sensor configured for a vessel publishes on its own topic:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 24%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th>Sensor</th>
<th>Topic</th>
<th>Message Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>IMU</td>
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/imu</code></td>
<td><code>sensor_msgs/Imu</code></td>
</tr>
<tr class="even">
<td>GPS</td>
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/gps</code></td>
<td><code>sensor_msgs/NavSatFix</code></td>
</tr>
<tr class="odd">
<td>DVL</td>
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/dvl</code></td>
<td><code>interfaces/DVL</code></td>
</tr>
<tr class="even">
<td>UWB</td>
<td><code>/&lt;vessel_name&gt;_&lt;id&gt;/uwb</code></td>
<td><code>geometry_msgs/PoseWithCovarianceStamped</code></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="sensor-integration" class="level2">
<h2 class="anchored" data-anchor-id="sensor-integration">Sensor Integration</h2>
<p>Sensors are created and managed through the Vessel_Pub_Sub class:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%
flowchart LR
    subgraph VesselConfig["Vessel Configuration"]
        SensorConfig["Sensor Configuration"]
    end
    
    subgraph VesselPubSub["Vessel_Pub_Sub"]
        SensorCreation["Sensor Creation"]
        Publishers["Sensor Publishers"]
        Timers["Publication Timers"]
    end
    
    subgraph SensorFunctions["Sensor Functions"]
        GetMeasurement["get_measurement()"]
        CreateMessage["_create_sensor_message()"]
        PublishSensor["_publish_sensor()"]
    end
    
    subgraph ROS2["ROS2 Network"]
        Topics["Sensor Topics"]
    end
    
    SensorConfig --&gt; SensorCreation
    SensorCreation --&gt; Publishers
    SensorCreation --&gt; Timers
    Timers --&gt; PublishSensor
    PublishSensor --&gt; GetMeasurement
    PublishSensor --&gt; CreateMessage
    CreateMessage --&gt; Topics
    
    classDef config fill:#5D8AA8,stroke:#1F456E,color:white;
    classDef pubsub fill:#6B8E23,stroke:#2E3B0F,color:white;
    classDef functions fill:#FFD700,stroke:#B8860B,color:black;
    classDef network fill:#966FD6,stroke:#4A357A,color:white;
    
    class VesselConfig,SensorConfig config;
    class VesselPubSub,SensorCreation,Publishers,Timers pubsub;
    class SensorFunctions,GetMeasurement,CreateMessage,PublishSensor functions;
    class ROS2,Topics network;
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Detailed Function Calls in Sensor Integration:</strong></p>
<ol type="1">
<li><strong>SensorConfig to SensorCreation</strong>:
<ul>
<li>During <code>Vessel_Pub_Sub</code> initialization, it reads sensor configurations from <code>vessel.vessel_config['sensors']</code></li>
<li>For each sensor configuration, it calls <code>create_sensor(sensor_config, vessel_id, topic_prefix, self)</code></li>
</ul></li>
<li><strong>SensorCreation to Publishers and Timers</strong>:
<ul>
<li><p>After creating a sensor object, <code>Vessel_Pub_Sub</code> creates a publisher using:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.world_node.create_publisher(<span class="va">self</span>._get_msg_type(sensor.sensor_type), sensor_topic, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>It also creates a timer for each sensor:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.world_node.create_timer(<span class="dv">1</span><span class="op">/</span>sensor.rate, <span class="kw">lambda</span> s<span class="op">=</span>sensor: <span class="va">self</span>._publish_sensor(s))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>Timer to PublishSensor</strong>:
<ul>
<li>Each timer periodically calls <code>_publish_sensor(sensor)</code> at the sensor’s configured rate</li>
</ul></li>
<li><strong>PublishSensor to GetMeasurement</strong>:
<ul>
<li>The <code>_publish_sensor</code> method calls <code>sensor.get_measurement()</code> to obtain the latest sensor reading</li>
<li>Each sensor type has its own implementation of <code>get_measurement()</code></li>
</ul></li>
<li><strong>PublishSensor to CreateMessage</strong>:
<ul>
<li>After getting the measurement, <code>_publish_sensor</code> calls <code>_create_sensor_message(sensor_type, measurement)</code></li>
<li>This converts the measurement to the appropriate ROS2 message type</li>
</ul></li>
<li><strong>CreateMessage to Topics</strong>:
<ul>
<li><p>Finally, the message is published to the ROS2 network:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>s[<span class="st">'pub'</span>].publish(msg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ol>
<p>The process for sensor integration:</p>
<ol type="1">
<li>Sensor configurations are defined in the vessel parameters (input files <code>sensors.yml</code>)</li>
<li>The Vessel_Pub_Sub class creates sensor objects using the <code>create_sensor</code> factory function</li>
<li>For each sensor, a publisher and timer are created</li>
<li>The timer periodically calls the sensor’s <code>get_measurement()</code> method</li>
<li>Measurements are converted to ROS2 messages and published</li>
</ol>
<p>Key methods in the sensor integration:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _publish_sensor(<span class="va">self</span>, sensor):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Publish sensor data."""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    measurement <span class="op">=</span> sensor.get_measurement()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">=</span> <span class="va">self</span>._create_sensor_message(sensor.sensor_type, measurement)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the publisher for this sensor</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> <span class="va">self</span>.sensors:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s[<span class="st">'sensor'</span>] <span class="op">==</span> sensor:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            s[<span class="st">'pub'</span>].publish(msg)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _create_sensor_message(<span class="va">self</span>, sensor_type, measurement):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a ROS message for sensor data."""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    current_time <span class="op">=</span> <span class="va">self</span>.world_node.get_clock().now().to_msg()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create appropriate message based on sensor type</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sensor_type <span class="op">==</span> <span class="st">'IMU'</span>:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> Imu()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill message fields</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> sensor_type <span class="op">==</span> <span class="st">'GPS'</span>:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> NavSatFix()</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill message fields</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... other sensor types</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> msg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="actuator-control" class="level2">
<h2 class="anchored" data-anchor-id="actuator-control">Actuator Control</h2>
<p>Vessels can be controlled through ROS2 by sending actuator commands:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%
flowchart LR
    subgraph External["External Controller"]
        ControlAlgorithm["Control Algorithm"]
        ActuatorMsg["Actuator Message"]
    end
    
    subgraph ROS2["ROS2 Network"]
        ActuatorTopic["/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd"]
    end
    
    subgraph VesselPubSub["Vessel_Pub_Sub"]
        Subscriber["Actuator Subscriber"]
        Callback["actuator_callback()"]
    end
    
    subgraph Vessel["Vessel"]
        ControlSurfaces["Control Surfaces (delta_c)"]
        Thrusters["Thrusters (n_c)"]
    end
    
    ControlAlgorithm --&gt; ActuatorMsg
    ActuatorMsg --&gt; ActuatorTopic
    ActuatorTopic --&gt; Subscriber
    Subscriber --&gt; Callback
    Callback --&gt; ControlSurfaces
    Callback --&gt; Thrusters
    
    classDef external fill:#FF6347,stroke:#8B3626,color:white;
    classDef ros2 fill:#966FD6,stroke:#4A357A,color:white;
    classDef pubsub fill:#6B8E23,stroke:#2E3B0F,color:white;
    classDef vessel fill:#5D8AA8,stroke:#1F456E,color:white;
    
    class External,ControlAlgorithm,ActuatorMsg external;
    class ROS2,ActuatorTopic ros2;
    class VesselPubSub,Subscriber,Callback pubsub;
    class Vessel,ControlSurfaces,Thrusters vessel;
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Detailed Function Calls in Actuator Control:</strong></p>
<ol type="1">
<li><strong>ControlAlgorithm to ActuatorMsg</strong>:
<ul>
<li>External control algorithms compute desired actuator values</li>
<li>They create an <code>Actuator</code> message with the desired values</li>
</ul></li>
<li><strong>ActuatorMsg to ActuatorTopic</strong>:
<ul>
<li>The controller publishes the message to the actuator command topic</li>
<li>This is done using ROS2’s <code>publisher.publish(msg)</code> mechanism</li>
</ul></li>
<li><strong>ActuatorTopic to Subscriber</strong>:
<ul>
<li><p>The subscriber in <code>Vessel_Pub_Sub</code> receives the message</p></li>
<li><p>This was set up during initialization with:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.actuator_sub <span class="op">=</span> <span class="va">self</span>.world_node.create_subscription(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    Actuator, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/actuator_cmd'</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.actuator_callback, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>Subscriber to Callback</strong>:
<ul>
<li>The subscriber triggers <code>actuator_callback(msg)</code> in <code>Vessel_Pub_Sub</code></li>
</ul></li>
<li><strong>Callback to ControlSurfaces and Thrusters</strong>:
<ul>
<li><p>The callback parses the message and updates vessel control values:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For control surfaces</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.vessel.delta_c[idx] <span class="op">=</span> value <span class="op">*</span> np.pi <span class="op">/</span> <span class="fl">180.0</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For thrusters</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.vessel.n_c[idx] <span class="op">=</span> value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ol>
<section id="actuator-message-structure-actuator.msg" class="level3">
<h3 class="anchored" data-anchor-id="actuator-message-structure-actuator.msg">Actuator Message Structure (<code>Actuator.msg</code>)</h3>
<p>The <code>Actuator.msg</code> is a custom message type used for controlling vessel actuators. Its structure is:</p>
<pre><code>std_msgs/Header header       # Standard header with timestamp
string[] actuator_names      # Array of actuator identifiers
float64[] actuator_values    # Array of corresponding values</code></pre>
<p>The actuator names use a prefixing convention: - <code>cs_N</code> for control surfaces (e.g., <code>cs_1</code> for the first control surface) - <code>th_N</code> for thrusters (e.g., <code>th_1</code> for the first thruster)</p>
<p>Values for control surfaces are specified in <strong>degrees</strong> (converted to radians internally) and values for thrusters are in <strong>RPM</strong> (Revolutions Per Minute).</p>
<p>Example usage in <code>class_vessel_pub_sub_ros2.py</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> actuator_callback(<span class="va">self</span>, msg):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Handle actuator command messages."""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(msg.actuator_names) <span class="op">!=</span> <span class="bu">len</span>(msg.actuator_values):</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world_node.get_logger().warn(<span class="st">'Mismatch between actuator IDs and values length'</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> actuator_id, value <span class="kw">in</span> <span class="bu">zip</span>(msg.actuator_names, msg.actuator_values):</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> actuator_id.startswith(<span class="st">'cs_'</span>):</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle control surface (convert degrees to radians)</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> actuator_id <span class="kw">in</span> <span class="va">self</span>.control_surface_ids:</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                    idx <span class="op">=</span> <span class="va">self</span>.control_surface_ids[actuator_id]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.vessel.delta_c[idx] <span class="op">=</span> value <span class="op">*</span> np.pi <span class="op">/</span> <span class="fl">180.0</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown control surface ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> actuator_id.startswith(<span class="st">'th_'</span>):</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle thruster (RPM value)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> actuator_id <span class="kw">in</span> <span class="va">self</span>.thruster_ids:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                    idx <span class="op">=</span> <span class="va">self</span>.thruster_ids[actuator_id]</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.vessel.n_c[idx] <span class="op">=</span> value</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown thruster ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Invalid actuator ID format: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">. Must start with cs_ or th_'</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">IndexError</span>):</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown actuator ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>During initialization, <code>Vessel_Pub_Sub</code> builds mappings between actuator IDs (as defined in <code>control_surfaces.yml</code> and <code>thrusters.yml</code>) and their indices:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store actuator IDs with type prefixes</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_surface_ids <span class="op">=</span> {}  <span class="co"># Maps 'cs_id' to index</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.thruster_ids <span class="op">=</span> {}        <span class="co"># Maps 'th_id' to index</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, cs <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.control_surfaces):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    cs_id <span class="op">=</span> cs.get(<span class="st">'control_surface_id'</span>, idx<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_surface_ids[<span class="ss">f'cs_</span><span class="sc">{</span>cs_id<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> idx</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, th <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.thrusters):</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    th_id <span class="op">=</span> th.get(<span class="st">'thruster_id'</span>, idx<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.thruster_ids[<span class="ss">f'th_</span><span class="sc">{</span>th_id<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> idx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These mappings ensure that actuator commands are properly routed to the correct control surfaces and thrusters in the vessel’s internal state.</p>
</section>
</section>
<section id="world-and-vessel-population" class="level2">
<h2 class="anchored" data-anchor-id="world-and-vessel-population">World and Vessel Population</h2>
<p>The process of populating the world with vessels follows these steps:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%
flowchart TB
    Start["Start Simulation&lt;br&gt;(simulate.py)"]
    Init["Initialize ROS2"]
    CreateWorld["Create World&lt;br&gt;(from input file)"]
    CreateNode["Create World_Node"]
    SetNode["Set world.node reference"]
    StartVessels["Start vessel ROS nodes"]
    SpinThread["Run ROS2 spin in thread"]
    PrintInfo["Print ROS2 topics and info"]
    
    Start --&gt; Init
    Init --&gt; CreateWorld
    CreateWorld --&gt; CreateNode
    CreateNode --&gt; SetNode
    SetNode --&gt; StartVessels
    StartVessels --&gt; SpinThread
    SpinThread --&gt; PrintInfo
    
    CreateWorld -- "Read from YAML" --&gt; ReadConfig["Read configurations"]
    ReadConfig --&gt; ParseWorld["Parse world parameters"]
    ParseWorld --&gt; CreateVessels["Create vessel instances"]
    
    StartVessels --&gt; |"For each vessel"| CreateVesselPubSub["Create Vessel_Pub_Sub"]
    CreateVesselPubSub --&gt; SetupPublishers["Set up publishers"]
    CreateVesselPubSub --&gt; SetupSubscribers["Set up subscribers"]
    CreateVesselPubSub --&gt; SetupSensors["Set up sensors"]
    
    classDef start fill:#FF6347,stroke:#8B3626,color:white;
    classDef ros2 fill:#966FD6,stroke:#4A357A,color:white;
    classDef world fill:#5D8AA8,stroke:#1F456E,color:white;
    classDef vessel fill:#6B8E23,stroke:#2E3B0F,color:white;
    
    class Start,Init,SpinThread,PrintInfo start;
    class CreateNode,SetNode ros2;
    class CreateWorld,ReadConfig,ParseWorld world;
    class CreateVessels,StartVessels,CreateVesselPubSub,SetupPublishers,SetupSubscribers,SetupSensors vessel;
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Detailed Function Calls in World and Vessel Population:</strong></p>
<ol type="1">
<li><strong>Start to Init</strong>:
<ul>
<li><code>simulate.py</code> starts and calls <code>rclpy.init()</code> to initialize the ROS2 middleware</li>
<li>This initializes the ROS2 context for the application</li>
</ul></li>
<li><strong>Init to CreateWorld</strong>:
<ul>
<li><code>World('/workspaces/mavlab/inputs/simulation_input.yml')</code> is called</li>
<li>This creates the World instance and loads configuration</li>
</ul></li>
<li><strong>CreateWorld to ReadConfig</strong>:
<ul>
<li><code>World.__init__</code> calls <code>self.process_world_input(world_file)</code></li>
<li><code>process_world_input</code> calls <code>read_input(world_file)</code> to parse YAML</li>
</ul></li>
<li><strong>ReadConfig to ParseWorld</strong>:
<ul>
<li><code>process_world_input</code> extracts world parameters like:
<ul>
<li><code>self.size = np.array(sim_params['world_size'])</code></li>
<li><code>self.nvessels = sim_params['nagents']</code></li>
<li><code>self.gps_datum = np.array(sim_params['gps_datum'])</code></li>
</ul></li>
</ul></li>
<li><strong>ParseWorld to CreateVessels</strong>:
<ul>
<li><p><code>process_world_input</code> creates vessel instances:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.vessels.append(Vessel(vessel_params<span class="op">=</span>vessel_config,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                          hydrodynamic_data<span class="op">=</span>hydrodynamic_data,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                          vessel_id<span class="op">=</span>agent_count))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>CreateWorld to CreateNode</strong>:
<ul>
<li><code>World_Node(world_rate=1/world.dt)</code> is called</li>
<li>This creates a ROS2 node wrapper for the World</li>
</ul></li>
<li><strong>SetNode to StartVessels</strong>:
<ul>
<li><code>world.start_vessel_ros_nodes(world_node)</code> is called</li>
<li>This iterates through vessels and creates ROS2 interfaces</li>
</ul></li>
<li><strong>StartVessels to CreateVesselPubSub</strong>:
<ul>
<li><code>Vessel_Pub_Sub(vessel, world_node)</code> is called for each vessel</li>
<li>Each vessel gets its own ROS2 communication interface</li>
</ul></li>
<li><strong>CreateVesselPubSub to SetupPublishers</strong>:
<ul>
<li><p>Publishers are created for each vessel’s odometry and state:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.odometry <span class="op">=</span> {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pub'</span>: <span class="va">self</span>.world_node.create_publisher(Odometry, <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/odometry_sim'</span>, <span class="dv">10</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'timer'</span>: <span class="va">self</span>.world_node.create_timer(<span class="va">self</span>.vessel.vessel_config[<span class="st">'time_step'</span>], <span class="va">self</span>.publish_odometry)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>CreateVesselPubSub to SetupSubscribers</strong>:
<ul>
<li><p>Subscribers are created for actuator commands:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.actuator_sub <span class="op">=</span> <span class="va">self</span>.world_node.create_subscription(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    Actuator, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/actuator_cmd'</span>, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.actuator_callback, </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>CreateVesselPubSub to SetupSensors</strong>:
<ul>
<li><p>Sensors are created and configured based on vessel configuration:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sensor <span class="op">=</span> create_sensor(sensor_config, <span class="va">self</span>.vessel_id, <span class="va">self</span>.topic_prefix, <span class="va">self</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.sensors.append({</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sensor'</span>: sensor,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pub'</span>: <span class="va">self</span>.world_node.create_publisher(<span class="va">self</span>._get_msg_type(sensor.sensor_type), sensor_topic, <span class="dv">10</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'timer'</span>: <span class="va">self</span>.world_node.create_timer(<span class="dv">1</span><span class="op">/</span>sensor.rate, <span class="kw">lambda</span> s<span class="op">=</span>sensor: <span class="va">self</span>._publish_sensor(s))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><strong>StartVessels to SpinThread</strong>:
<ul>
<li><code>threading.Thread(target=ros_thread, args=(world_node,))</code> is created and started</li>
<li>This runs <code>rclpy.spin(node)</code> in a separate thread</li>
</ul></li>
<li><strong>SpinThread to PrintInfo</strong>:
<ul>
<li>Available ROS2 topics are listed and helpful usage information is printed</li>
</ul></li>
</ol>
<p>Key steps in this process:</p>
<ol type="1">
<li>The simulation begins in <code>simulate.py</code></li>
<li>ROS2 is initialized</li>
<li>A World object is created from the input configuration file</li>
<li>A World_Node is created and linked to the World object</li>
<li>Vessel ROS nodes are started for each vessel in the world</li>
<li>For each vessel, a Vessel_Pub_Sub object is created, which:
<ul>
<li>Sets up publishers for odometry and vessel state</li>
<li>Sets up subscribers for actuator commands</li>
<li>Creates sensor objects based on the vessel configuration</li>
<li>Sets up timers for publishing sensor data</li>
</ul></li>
</ol>
</section>
<section id="running-the-simulation" class="level2">
<h2 class="anchored" data-anchor-id="running-the-simulation">Running the Simulation</h2>
<p>To run the MAV simulator with ROS2 integration:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to the workspace</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /path/to/makara</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build ROS2 packages</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">colcon</span> build</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Source the workspace</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> install/setup.bash</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulator</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> run mav_simulator simulate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After starting the simulation, you can interact with it using standard ROS2 commands:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List all available topics</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic list</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscribe to vessel odometry</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic echo /<span class="op">&lt;</span>vessel_name<span class="op">&gt;</span>_<span class="op">&lt;</span>id<span class="op">&gt;</span>/odometry_sim</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Publish control commands</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic pub /<span class="op">&lt;</span>vessel_name<span class="op">&gt;</span>_<span class="op">&lt;</span>id<span class="op">&gt;</span>/actuator_cmd interfaces/Actuator <span class="dt">\</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="st">"{header: {stamp: {sec: 0}}, actuator_names: ['cs_1', 'th_1'], actuator_values: [15.0, 1200.0]}"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="best-practices" class="level2">
<h2 class="anchored" data-anchor-id="best-practices">Best Practices</h2>
<ul>
<li><strong>Launch Files</strong>: Create launch files for different simulation scenarios. There are some example launch files in the <code>/workspace/mavlab/ros2_ws/src/mav_simulator/mav_simulator/launch</code> folder.</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../rawFiles/Inputs/inputs.html" class="pagination-link" aria-label="Simualtion Inputs">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Simualtion Inputs</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../rawFiles/WebConfigurator/web_configurator.html" class="pagination-link" aria-label="Vessel Configurator">
        <span class="nav-page-text">Vessel Configurator</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># ROS2 Architecture {.unnumbered}</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>The Panisim runs on the Robot Operating System 2 (ROS2), enabling distributed simulation, external control, visualization, and data recording. The ROS2 integration architecture follows a modular design pattern that separates the simulation core from the communication layer. The Docker container of the simlator runs ROS2 Humble.</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>The ROS2 integration allows the Panisim to run completely isolated from controllers or guidance systems, thus enabling you to code your own controllers or guidance systems to interact with the simulator.</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Architecture</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>The ROS2 integration consists of several key components that work together to bridge the simulation with the ROS2 ecosystem:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="in">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart TB</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph Simulation["Simulation Core"]</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="in">        World["World Class&lt;br&gt;(class_world.py)"]</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="in">        Vessel["Vessel Class&lt;br&gt;(class_vessel.py)"]</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="in">        Vessel2["Vessel Class&lt;br&gt;(Additional Vessels)"]</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="in">        World --&gt; Vessel</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="in">        World --&gt; Vessel2</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph ROS2["ROS2 Integration"]</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="in">        World_Node["World_Node&lt;br&gt;(class_world_node_ros2.py)"]</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="in">        Vessel_Pub_Sub["Vessel_Pub_Sub&lt;br&gt;(class_vessel_pub_sub_ros2.py)"]</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="in">        Vessel_Pub_Sub2["Vessel_Pub_Sub&lt;br&gt;(Additional Vessels)"]</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph Applications["ROS2 Ecosystem"]</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="in">        Controllers["External Controllers"]</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="in">        Visualization["Visualization Tools&lt;br&gt;(RViz, Foxglove)"]</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="in">        Logging["Data Logging"]</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="in">        Other["Other ROS2 Nodes"]</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="in">    Main["Main Simulation Script&lt;br&gt;(simulate.py)"] --&gt; World</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="in">    Main --&gt; World_Node</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="in">    World_Node --&gt; World</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel --&gt; Vessel_Pub_Sub</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel2 --&gt; Vessel_Pub_Sub2</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub --&gt; Controllers</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub --&gt; Visualization</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub --&gt; Logging</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub --&gt; Other</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub2 --&gt; Controllers</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub2 --&gt; Visualization</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub2 --&gt; Logging</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="in">    Vessel_Pub_Sub2 --&gt; Other</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="in">    World_Node --- Vessel_Pub_Sub</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="in">    World_Node --- Vessel_Pub_Sub2</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef core fill:#5D8AA8,stroke:#1F456E,color:white;</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef ros2 fill:#6B8E23,stroke:#2E3B0F,color:white;</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef app fill:#966FD6,stroke:#4A357A,color:white;</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef main fill:#FF6347,stroke:#8B3626,color:white;</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="in">    class World,Vessel,Vessel2 core;</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="in">    class World_Node,Vessel_Pub_Sub,Vessel_Pub_Sub2 ros2;</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="in">    class Controllers,Visualization,Logging,Other app;</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="in">    class Main main;</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>**Explanation of the Architecture Flow:**</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Main Simulation Script (`simulate.py`)**: Initiates the simulation by:</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Calling <span class="in">`rclpy.init()`</span> to initialize the ROS2 middleware</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Creating a <span class="in">`World`</span> instance by calling <span class="in">`World(config_file_path)`</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Instantiating a <span class="in">`World_Node`</span> that wraps the simulation in ROS2</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Calling <span class="in">`world.start_vessel_ros_nodes(world_node)`</span> to connect vessels to ROS2</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**World Class (`class_world.py`)**: </span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Maintains multiple vessel instances using <span class="in">`vessels = []`</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Processes world input with <span class="in">`process_world_input(world_file)`</span> </span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Creates vessels via <span class="in">`Vessel(vessel_params, hydrodynamic_data, vessel_id)`</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Updates simulation state with <span class="in">`step()`</span> method that calls <span class="in">`vessel.step()`</span> for each vessel</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**World_Node Class (`class_world_node_ros2.py`)**:</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Inherits from ROS2 <span class="in">`Node`</span> class</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Creates a timer with <span class="in">`create_timer(1/self.rate, self.world.step)`</span> to drive simulation</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Vessel_Pub_Sub Class (`class_vessel_pub_sub_ros2.py`)**:</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Creates publishers, subscribers, and timers for each vessel</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Publishes vessel state and sensor data</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Handles actuator commands via subscribers</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Components</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="fu">### Main Simulation Script (`simulate.py`)</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>The entry point for running Panisim with ROS2 integration. This script:</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Initializes the ROS2 environment</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Creates the World simulation instance</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Sets up the World_Node for ROS2 communication</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Establishes connections between simulation and ROS2</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Runs the ROS2 spin loop in a separate thread</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creates an object of class 'World'</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>    rclpy.init()</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    world <span class="op">=</span> World(<span class="st">'/workspaces/mavlab/inputs/simulation_input.yml'</span>)</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    world_node <span class="op">=</span> World_Node(world_rate<span class="op">=</span><span class="dv">1</span><span class="op">/</span>world.dt)</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>    world.node <span class="op">=</span> world_node</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>    world.start_vessel_ros_nodes(world_node)</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run ROS on a separate thread</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    ros_thread_instance <span class="op">=</span> threading.Thread(target<span class="op">=</span>ros_thread, args<span class="op">=</span>(world_node,))</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    ros_thread_instance.start()</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prints available ROS2 topics and usage information</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ros_thread`</span> function is defined as:</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ros_thread(node):</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>    rclpy.spin(node)</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    rclpy.shutdown()</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>This function handles the ROS2 event loop, allowing callbacks to be processed in the background while the main thread can perform other tasks.</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### World Class (`class_world.py`)</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>The World class serves as the simulation environment container, managing:</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Multiple vessel instances within a unified simulation</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Initialization from configuration files</span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Simulation time stepping across all vessels</span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Global parameters like GPS datum and world boundaries</span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> World():</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>    terminate <span class="op">=</span> <span class="va">False</span>                   <span class="co"># Flag indicating simulation termination</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>    vessels <span class="op">=</span> []                        <span class="co"># List of Vessel objects</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>    nvessels <span class="op">=</span> <span class="dv">0</span>                        <span class="co"># Number of vessels</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    size <span class="op">=</span> np.zeros(<span class="dv">3</span>)                  <span class="co"># Size of the world (X-Y-Z)</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>    gps_datum <span class="op">=</span> <span class="va">None</span>                    <span class="co"># GPS reference point</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    node <span class="op">=</span> <span class="va">None</span>                         <span class="co"># ROS2 node reference</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> <span class="fl">0.01</span>                           <span class="co"># Simulation time step</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize the World object from configuration file"""</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> world_file <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.process_world_input(world_file)</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>):</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Advance the simulation by one time step"""</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> vessel <span class="kw">in</span> <span class="va">self</span>.vessels:</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>            vessel.step()</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>The <span class="in">`process_world_input`</span> method reads the simulation configuration from YAML files:</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_world_input(<span class="va">self</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>        sim_params, agents <span class="op">=</span> read_input(world_file)</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> np.array(sim_params[<span class="st">'world_size'</span>])</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.nvessels <span class="op">=</span> sim_params[<span class="st">'nagents'</span>]</span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gps_datum <span class="op">=</span> np.array(sim_params[<span class="st">'gps_datum'</span>])</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>        agent_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dt <span class="op">=</span> sim_params[<span class="st">'time_step'</span>]</span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> agent <span class="kw">in</span> agents[<span class="dv">0</span>:<span class="va">self</span>.nvessels]:</span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>            vessel_config <span class="op">=</span> agent[<span class="st">'vessel_config'</span>]</span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>            hydrodynamic_data <span class="op">=</span> agent[<span class="st">'hydrodynamics'</span>]</span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.vessels.append(Vessel(vessel_params<span class="op">=</span>vessel_config, </span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>                                      hydrodynamic_data<span class="op">=</span>hydrodynamic_data, </span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>                                      vessel_id<span class="op">=</span>agent_count))</span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>            agent_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> yaml.YAMLError <span class="im">as</span> exc:</span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(exc)</span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>        exit()</span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a>The World class includes a method to start the ROS2 nodes for all vessels:</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_vessel_ros_nodes(<span class="va">self</span>, world_node):</span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Initialize ROS2 nodes for all vessels in the world"""</span></span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> vessel <span class="kw">in</span> <span class="va">self</span>.vessels:</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>        vessel.vessel_node <span class="op">=</span> Vessel_Pub_Sub(vessel, world_node)</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a><span class="fu">### World_Node Class (`class_world_node_ros2.py`)</span></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>The World_Node class is a ROS2 node wrapper for the World class:</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> World_Node(Node):</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, world_rate<span class="op">=</span><span class="dv">100</span>, world_file<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">'world'</span>)</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rate <span class="op">=</span> world_rate</span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world <span class="op">=</span> World(world_file)</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.create_timer(<span class="dv">1</span><span class="op">/</span><span class="va">self</span>.rate, callback<span class="op">=</span><span class="va">self</span>.world.step)</span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>This class:</span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Inherits from the ROS2 Node class</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creates a timer that triggers the simulation step function at a specified rate</span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Provides the ROS2 context for the World class</span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>The <span class="in">`create_timer`</span> method sets up a timer that calls the <span class="in">`World.step()`</span> method at regular intervals determined by <span class="in">`world_rate`</span>. This is what drives the simulation forward in time while maintaining synchronization with the ROS2 ecosystem.</span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vessel_Pub_Sub Class (`class_vessel_pub_sub_ros2.py`)</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>The Vessel_Pub_Sub class implements the ROS2 communication interface for vessel objects:</span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vessel_Pub_Sub():</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vessel, world_node):</span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize the vessel interface"""</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world_node <span class="op">=</span> world_node</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel <span class="op">=</span> vessel</span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel_id <span class="op">=</span> vessel.vessel_id</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vessel_name <span class="op">=</span> vessel.vessel_name</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.topic_prefix <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>vessel_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>vessel_id<span class="sc">:02d}</span><span class="ss">'</span></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize publishers, subscribers, and timers</span></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...</span></span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>This class:</span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creates and manages ROS2 publishers for vessel state and sensor data</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sets up subscribers for actuator commands</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handles message conversion between simulator data and ROS2 messages</span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Manages sensor data publication at appropriate rates</span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>Key initialization methods include:</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Setting up control surface and thruster mappings</span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creating sensor objects and their publishers</span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Initializing odometry and vessel state publishers</span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creating actuator command subscribers</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a><span class="fu">## Message Flow</span></span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>The communication between simulation components and the ROS2 ecosystem follows this message flow:</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a><span class="in">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%</span></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a><span class="in">sequenceDiagram</span></span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a><span class="in">    participant S as Simulation</span></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a><span class="in">    participant VP as Vessel_Pub_Sub</span></span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a><span class="in">    participant R as ROS2 Network</span></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a><span class="in">    participant E as External Nodes</span></span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a><span class="in">    S-&gt;&gt;VP: Vessel state update</span></span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a><span class="in">    S-&gt;&gt;VP: Sensor data</span></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a><span class="in">    VP-&gt;&gt;R: Publish odometry</span></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a><span class="in">    VP-&gt;&gt;R: Publish vessel state</span></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a><span class="in">    VP-&gt;&gt;R: Publish sensor data (IMU, GPS, etc.)</span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a><span class="in">    E-&gt;&gt;R: Subscribe to vessel data</span></span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a><span class="in">    E-&gt;&gt;R: Process and visualize</span></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a><span class="in">    E-&gt;&gt;R: Publish control commands</span></span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a><span class="in">    R-&gt;&gt;VP: Actuator commands</span></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a><span class="in">    VP-&gt;&gt;S: Update vessel actuators</span></span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="in">    Note over S,VP: Simulation Step</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a><span class="in">    S-&gt;&gt;S: Advance simulation</span></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a>**Detailed Function Call Sequence:**</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Vessel State Update**: </span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`vessel.step()`</span> in <span class="in">`World.step()`</span> updates the vessel state</span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This updates <span class="in">`vessel.current_state`</span>, which is accessed by publishers</span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Sensor Data Generation**:</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Sensor objects call <span class="in">`get_measurement()`</span> to generate simulated sensor readings based on vessel state</span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Publishing Data to ROS2**:</span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`publish_odometry()`</span> is called by a timer to publish vessel position and orientation</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`publish_vessel_state()`</span> is called by a timer to publish complete state vector</span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`_publish_sensor()`</span> is called by sensor-specific timers to publish sensor data</span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**External Nodes Subscribing**:</span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>External ROS2 nodes subscribe to topics using <span class="in">`ros2 topic echo`</span> or programmatically</span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Control Commands**:</span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>External nodes publish to <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd`</span></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`actuator_callback(msg)`</span> processes these commands</span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Updating Actuator States**:</span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`vessel.delta_c`</span> (control surfaces) and <span class="in">`vessel.n_c`</span> (thrusters) are updated</span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>These affect the vessel dynamics in the next simulation step</span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Simulation Step**:</span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The timer in <span class="in">`World_Node`</span> triggers <span class="in">`world.step()`</span></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This advances all vessels' states using their dynamics models</span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Topics and Messages</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>Each vessel in the simulation publishes data on several ROS2 topics:</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a><span class="fu">### Standard Topics</span></span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>| Topic | Message Type | Description |</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>|-------|--------------|-------------|</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a>| <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/odometry_sim`</span> | <span class="in">`nav_msgs/Odometry`</span> | Vessel position, orientation, and velocities |</span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>| <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/vessel_state`</span> | <span class="in">`std_msgs/Float64MultiArray`</span> | Complete vessel state including actuators |</span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a>| <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd`</span> | <span class="in">`interfaces/Actuator`</span> | Commands for control surfaces and thrusters |</span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sensor Topics</span></span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a>Each sensor configured for a vessel publishes on its own topic:</span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a>| Sensor | Topic | Message Type |</span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a>|--------|-------|--------------|</span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>| IMU | <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/imu`</span> | <span class="in">`sensor_msgs/Imu`</span> |</span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>| GPS | <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/gps`</span> | <span class="in">`sensor_msgs/NavSatFix`</span> |</span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>| DVL | <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/dvl`</span> | <span class="in">`interfaces/DVL`</span> |</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a>| UWB | <span class="in">`/&lt;vessel_name&gt;_&lt;id&gt;/uwb`</span> | <span class="in">`geometry_msgs/PoseWithCovarianceStamped`</span> |</span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sensor Integration</span></span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a>Sensors are created and managed through the Vessel_Pub_Sub class:</span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a><span class="in">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%</span></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart LR</span></span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph VesselConfig["Vessel Configuration"]</span></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a><span class="in">        SensorConfig["Sensor Configuration"]</span></span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph VesselPubSub["Vessel_Pub_Sub"]</span></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a><span class="in">        SensorCreation["Sensor Creation"]</span></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a><span class="in">        Publishers["Sensor Publishers"]</span></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a><span class="in">        Timers["Publication Timers"]</span></span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph SensorFunctions["Sensor Functions"]</span></span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a><span class="in">        GetMeasurement["get_measurement()"]</span></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a><span class="in">        CreateMessage["_create_sensor_message()"]</span></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a><span class="in">        PublishSensor["_publish_sensor()"]</span></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph ROS2["ROS2 Network"]</span></span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a><span class="in">        Topics["Sensor Topics"]</span></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a><span class="in">    SensorConfig --&gt; SensorCreation</span></span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a><span class="in">    SensorCreation --&gt; Publishers</span></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a><span class="in">    SensorCreation --&gt; Timers</span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a><span class="in">    Timers --&gt; PublishSensor</span></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a><span class="in">    PublishSensor --&gt; GetMeasurement</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a><span class="in">    PublishSensor --&gt; CreateMessage</span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateMessage --&gt; Topics</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef config fill:#5D8AA8,stroke:#1F456E,color:white;</span></span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef pubsub fill:#6B8E23,stroke:#2E3B0F,color:white;</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef functions fill:#FFD700,stroke:#B8860B,color:black;</span></span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef network fill:#966FD6,stroke:#4A357A,color:white;</span></span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a><span class="in">    class VesselConfig,SensorConfig config;</span></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a><span class="in">    class VesselPubSub,SensorCreation,Publishers,Timers pubsub;</span></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a><span class="in">    class SensorFunctions,GetMeasurement,CreateMessage,PublishSensor functions;</span></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a><span class="in">    class ROS2,Topics network;</span></span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a>**Detailed Function Calls in Sensor Integration:**</span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**SensorConfig to SensorCreation**:</span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>During <span class="in">`Vessel_Pub_Sub`</span> initialization, it reads sensor configurations from <span class="in">`vessel.vessel_config['sensors']`</span></span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>For each sensor configuration, it calls <span class="in">`create_sensor(sensor_config, vessel_id, topic_prefix, self)`</span></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**SensorCreation to Publishers and Timers**:</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>After creating a sensor object, <span class="in">`Vessel_Pub_Sub`</span> creates a publisher using: </span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.world_node.create_publisher(<span class="va">self</span>._get_msg_type(sensor.sensor_type), sensor_topic, <span class="dv">10</span>)</span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>It also creates a timer for each sensor:</span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.world_node.create_timer(<span class="dv">1</span><span class="op">/</span>sensor.rate, <span class="kw">lambda</span> s<span class="op">=</span>sensor: <span class="va">self</span>._publish_sensor(s))</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Timer to PublishSensor**:</span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Each timer periodically calls <span class="in">`_publish_sensor(sensor)`</span> at the sensor's configured rate</span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**PublishSensor to GetMeasurement**:</span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The <span class="in">`_publish_sensor`</span> method calls <span class="in">`sensor.get_measurement()`</span> to obtain the latest sensor reading</span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Each sensor type has its own implementation of <span class="in">`get_measurement()`</span></span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**PublishSensor to CreateMessage**:</span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>After getting the measurement, <span class="in">`_publish_sensor`</span> calls <span class="in">`_create_sensor_message(sensor_type, measurement)`</span></span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This converts the measurement to the appropriate ROS2 message type</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**CreateMessage to Topics**:</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Finally, the message is published to the ROS2 network:</span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a>     s[<span class="st">'pub'</span>].publish(msg)</span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a>The process for sensor integration:</span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Sensor configurations are defined in the vessel parameters (input files <span class="in">`sensors.yml`</span>)</span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>The Vessel_Pub_Sub class creates sensor objects using the <span class="in">`create_sensor`</span> factory function</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>For each sensor, a publisher and timer are created</span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>The timer periodically calls the sensor's <span class="in">`get_measurement()`</span> method</span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Measurements are converted to ROS2 messages and published</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a>Key methods in the sensor integration:</span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _publish_sensor(<span class="va">self</span>, sensor):</span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Publish sensor data."""</span></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a>    measurement <span class="op">=</span> sensor.get_measurement()</span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">=</span> <span class="va">self</span>._create_sensor_message(sensor.sensor_type, measurement)</span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the publisher for this sensor</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> <span class="va">self</span>.sensors:</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s[<span class="st">'sensor'</span>] <span class="op">==</span> sensor:</span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>            s[<span class="st">'pub'</span>].publish(msg)</span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _create_sensor_message(<span class="va">self</span>, sensor_type, measurement):</span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a ROS message for sensor data."""</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>    current_time <span class="op">=</span> <span class="va">self</span>.world_node.get_clock().now().to_msg()</span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create appropriate message based on sensor type</span></span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sensor_type <span class="op">==</span> <span class="st">'IMU'</span>:</span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> Imu()</span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill message fields</span></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> sensor_type <span class="op">==</span> <span class="st">'GPS'</span>:</span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> NavSatFix()</span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill message fields</span></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... other sensor types</span></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> msg</span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a><span class="fu">## Actuator Control</span></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>Vessels can be controlled through ROS2 by sending actuator commands:</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a><span class="in">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%</span></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart LR</span></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph External["External Controller"]</span></span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a><span class="in">        ControlAlgorithm["Control Algorithm"]</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a><span class="in">        ActuatorMsg["Actuator Message"]</span></span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph ROS2["ROS2 Network"]</span></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="in">        ActuatorTopic["/&lt;vessel_name&gt;_&lt;id&gt;/actuator_cmd"]</span></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph VesselPubSub["Vessel_Pub_Sub"]</span></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a><span class="in">        Subscriber["Actuator Subscriber"]</span></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a><span class="in">        Callback["actuator_callback()"]</span></span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a><span class="in">    subgraph Vessel["Vessel"]</span></span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a><span class="in">        ControlSurfaces["Control Surfaces (delta_c)"]</span></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a><span class="in">        Thrusters["Thrusters (n_c)"]</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a><span class="in">    end</span></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a><span class="in">    ControlAlgorithm --&gt; ActuatorMsg</span></span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a><span class="in">    ActuatorMsg --&gt; ActuatorTopic</span></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a><span class="in">    ActuatorTopic --&gt; Subscriber</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a><span class="in">    Subscriber --&gt; Callback</span></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a><span class="in">    Callback --&gt; ControlSurfaces</span></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a><span class="in">    Callback --&gt; Thrusters</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef external fill:#FF6347,stroke:#8B3626,color:white;</span></span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef ros2 fill:#966FD6,stroke:#4A357A,color:white;</span></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef pubsub fill:#6B8E23,stroke:#2E3B0F,color:white;</span></span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef vessel fill:#5D8AA8,stroke:#1F456E,color:white;</span></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a><span class="in">    class External,ControlAlgorithm,ActuatorMsg external;</span></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a><span class="in">    class ROS2,ActuatorTopic ros2;</span></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a><span class="in">    class VesselPubSub,Subscriber,Callback pubsub;</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="in">    class Vessel,ControlSurfaces,Thrusters vessel;</span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>**Detailed Function Calls in Actuator Control:**</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**ControlAlgorithm to ActuatorMsg**:</span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>External control algorithms compute desired actuator values</span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>They create an <span class="in">`Actuator`</span> message with the desired values</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**ActuatorMsg to ActuatorTopic**:</span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The controller publishes the message to the actuator command topic</span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This is done using ROS2's <span class="in">`publisher.publish(msg)`</span> mechanism</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**ActuatorTopic to Subscriber**:</span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The subscriber in <span class="in">`Vessel_Pub_Sub`</span> receives the message</span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This was set up during initialization with:</span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.actuator_sub <span class="op">=</span> <span class="va">self</span>.world_node.create_subscription(</span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>         Actuator, </span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/actuator_cmd'</span>, </span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a>         <span class="va">self</span>.actuator_callback, </span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span></span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Subscriber to Callback**:</span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The subscriber triggers <span class="in">`actuator_callback(msg)`</span> in <span class="in">`Vessel_Pub_Sub`</span></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Callback to ControlSurfaces and Thrusters**:</span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The callback parses the message and updates vessel control values:</span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a>     <span class="co"># For control surfaces</span></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.vessel.delta_c[idx] <span class="op">=</span> value <span class="op">*</span> np.pi <span class="op">/</span> <span class="fl">180.0</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a>     <span class="co"># For thrusters</span></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.vessel.n_c[idx] <span class="op">=</span> value</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a><span class="fu">### Actuator Message Structure (`Actuator.msg`)</span></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Actuator.msg`</span> is a custom message type used for controlling vessel actuators. Its structure is:</span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a><span class="in">std_msgs/Header header       # Standard header with timestamp</span></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a><span class="in">string[] actuator_names      # Array of actuator identifiers</span></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a><span class="in">float64[] actuator_values    # Array of corresponding values</span></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a>The actuator names use a prefixing convention:</span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`cs_N`</span> for control surfaces (e.g., <span class="in">`cs_1`</span> for the first control surface)</span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`th_N`</span> for thrusters (e.g., <span class="in">`th_1`</span> for the first thruster)</span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>Values for control surfaces are specified in **degrees** (converted to radians internally) and values for thrusters are in **RPM** (Revolutions Per Minute).</span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>Example usage in <span class="in">`class_vessel_pub_sub_ros2.py`</span>:</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> actuator_callback(<span class="va">self</span>, msg):</span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Handle actuator command messages."""</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(msg.actuator_names) <span class="op">!=</span> <span class="bu">len</span>(msg.actuator_values):</span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.world_node.get_logger().warn(<span class="st">'Mismatch between actuator IDs and values length'</span>)</span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> actuator_id, value <span class="kw">in</span> <span class="bu">zip</span>(msg.actuator_names, msg.actuator_values):</span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> actuator_id.startswith(<span class="st">'cs_'</span>):</span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle control surface (convert degrees to radians)</span></span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> actuator_id <span class="kw">in</span> <span class="va">self</span>.control_surface_ids:</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a>                    idx <span class="op">=</span> <span class="va">self</span>.control_surface_ids[actuator_id]</span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.vessel.delta_c[idx] <span class="op">=</span> value <span class="op">*</span> np.pi <span class="op">/</span> <span class="fl">180.0</span></span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown control surface ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> actuator_id.startswith(<span class="st">'th_'</span>):</span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle thruster (RPM value)</span></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> actuator_id <span class="kw">in</span> <span class="va">self</span>.thruster_ids:</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a>                    idx <span class="op">=</span> <span class="va">self</span>.thruster_ids[actuator_id]</span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.vessel.n_c[idx] <span class="op">=</span> value</span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown thruster ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Invalid actuator ID format: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">. Must start with cs_ or th_'</span>)</span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">IndexError</span>):</span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.world_node.get_logger().warn(<span class="ss">f'Unknown actuator ID: </span><span class="sc">{</span>actuator_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a>During initialization, <span class="in">`Vessel_Pub_Sub`</span> builds mappings between actuator IDs (as defined in  <span class="in">`control_surfaces.yml`</span> and <span class="in">`thrusters.yml`</span>) and their indices:</span>
<span id="cb24-583"><a href="#cb24-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a><span class="co"># Store actuator IDs with type prefixes</span></span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_surface_ids <span class="op">=</span> {}  <span class="co"># Maps 'cs_id' to index</span></span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.thruster_ids <span class="op">=</span> {}        <span class="co"># Maps 'th_id' to index</span></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, cs <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.control_surfaces):</span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a>    cs_id <span class="op">=</span> cs.get(<span class="st">'control_surface_id'</span>, idx<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_surface_ids[<span class="ss">f'cs_</span><span class="sc">{</span>cs_id<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> idx</span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, th <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.thrusters):</span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a>    th_id <span class="op">=</span> th.get(<span class="st">'thruster_id'</span>, idx<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.thruster_ids[<span class="ss">f'th_</span><span class="sc">{</span>th_id<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> idx</span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a>These mappings ensure that actuator commands are properly routed to the correct control surfaces and thrusters in the vessel's internal state.</span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a><span class="fu">## World and Vessel Population</span></span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a>The process of populating the world with vessels follows these steps:</span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a><span class="in">%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#5D8AA8', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1F456E', 'lineColor': '#1F456E', 'secondaryColor': '#006400', 'tertiaryColor': '#fff', 'textColor': '#192230' }}}%%</span></span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart TB</span></span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a><span class="in">    Start["Start Simulation&lt;br&gt;(simulate.py)"]</span></span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a><span class="in">    Init["Initialize ROS2"]</span></span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateWorld["Create World&lt;br&gt;(from input file)"]</span></span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateNode["Create World_Node"]</span></span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a><span class="in">    SetNode["Set world.node reference"]</span></span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a><span class="in">    StartVessels["Start vessel ROS nodes"]</span></span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a><span class="in">    SpinThread["Run ROS2 spin in thread"]</span></span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a><span class="in">    PrintInfo["Print ROS2 topics and info"]</span></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a><span class="in">    Start --&gt; Init</span></span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a><span class="in">    Init --&gt; CreateWorld</span></span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateWorld --&gt; CreateNode</span></span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateNode --&gt; SetNode</span></span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a><span class="in">    SetNode --&gt; StartVessels</span></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a><span class="in">    StartVessels --&gt; SpinThread</span></span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a><span class="in">    SpinThread --&gt; PrintInfo</span></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateWorld -- "Read from YAML" --&gt; ReadConfig["Read configurations"]</span></span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a><span class="in">    ReadConfig --&gt; ParseWorld["Parse world parameters"]</span></span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a><span class="in">    ParseWorld --&gt; CreateVessels["Create vessel instances"]</span></span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a><span class="in">    StartVessels --&gt; |"For each vessel"| CreateVesselPubSub["Create Vessel_Pub_Sub"]</span></span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateVesselPubSub --&gt; SetupPublishers["Set up publishers"]</span></span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateVesselPubSub --&gt; SetupSubscribers["Set up subscribers"]</span></span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a><span class="in">    CreateVesselPubSub --&gt; SetupSensors["Set up sensors"]</span></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef start fill:#FF6347,stroke:#8B3626,color:white;</span></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef ros2 fill:#966FD6,stroke:#4A357A,color:white;</span></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef world fill:#5D8AA8,stroke:#1F456E,color:white;</span></span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef vessel fill:#6B8E23,stroke:#2E3B0F,color:white;</span></span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a><span class="in">    class Start,Init,SpinThread,PrintInfo start;</span></span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a><span class="in">    class CreateNode,SetNode ros2;</span></span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a><span class="in">    class CreateWorld,ReadConfig,ParseWorld world;</span></span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a><span class="in">    class CreateVessels,StartVessels,CreateVesselPubSub,SetupPublishers,SetupSubscribers,SetupSensors vessel;</span></span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a>**Detailed Function Calls in World and Vessel Population:**</span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Start to Init**:</span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`simulate.py`</span> starts and calls <span class="in">`rclpy.init()`</span> to initialize the ROS2 middleware</span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This initializes the ROS2 context for the application</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Init to CreateWorld**:</span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`World('/workspaces/mavlab/inputs/simulation_input.yml')`</span> is called</span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This creates the World instance and loads configuration</span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**CreateWorld to ReadConfig**:</span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`World.__init__`</span> calls <span class="in">`self.process_world_input(world_file)`</span></span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`process_world_input`</span> calls <span class="in">`read_input(world_file)`</span> to parse YAML</span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**ReadConfig to ParseWorld**:</span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`process_world_input`</span> extracts world parameters like:</span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a><span class="ss">     - </span><span class="in">`self.size = np.array(sim_params['world_size'])`</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a><span class="ss">     - </span><span class="in">`self.nvessels = sim_params['nagents']`</span></span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a><span class="ss">     - </span><span class="in">`self.gps_datum = np.array(sim_params['gps_datum'])`</span></span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**ParseWorld to CreateVessels**:</span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`process_world_input`</span> creates vessel instances:</span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.vessels.append(Vessel(vessel_params<span class="op">=</span>vessel_config,</span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a>                               hydrodynamic_data<span class="op">=</span>hydrodynamic_data,</span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a>                               vessel_id<span class="op">=</span>agent_count))</span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**CreateWorld to CreateNode**:</span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`World_Node(world_rate=1/world.dt)`</span> is called</span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This creates a ROS2 node wrapper for the World</span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**SetNode to StartVessels**:</span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`world.start_vessel_ros_nodes(world_node)`</span> is called</span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This iterates through vessels and creates ROS2 interfaces</span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**StartVessels to CreateVesselPubSub**:</span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="in">`Vessel_Pub_Sub(vessel, world_node)`</span> is called for each vessel</span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Each vessel gets its own ROS2 communication interface</span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a><span class="ss">9. </span>**CreateVesselPubSub to SetupPublishers**:</span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Publishers are created for each vessel's odometry and state:</span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a>     <span class="in">```python</span></span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a>     <span class="va">self</span>.odometry <span class="op">=</span> {</span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a>         <span class="st">'pub'</span>: <span class="va">self</span>.world_node.create_publisher(Odometry, <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/odometry_sim'</span>, <span class="dv">10</span>),</span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a>         <span class="st">'timer'</span>: <span class="va">self</span>.world_node.create_timer(<span class="va">self</span>.vessel.vessel_config[<span class="st">'time_step'</span>], <span class="va">self</span>.publish_odometry)</span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a>     <span class="in">```</span></span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a><span class="ss">10. </span>**CreateVesselPubSub to SetupSubscribers**:</span>
<span id="cb24-696"><a href="#cb24-696" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>Subscribers are created for actuator commands:</span>
<span id="cb24-697"><a href="#cb24-697" aria-hidden="true" tabindex="-1"></a>      <span class="in">```python</span></span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.actuator_sub <span class="op">=</span> <span class="va">self</span>.world_node.create_subscription(</span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a>          Actuator, </span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>topic_prefix<span class="sc">}</span><span class="ss">/actuator_cmd'</span>, </span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.actuator_callback, </span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a>          <span class="dv">1</span></span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a>      <span class="in">```</span></span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a><span class="ss">11. </span>**CreateVesselPubSub to SetupSensors**:</span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>Sensors are created and configured based on vessel configuration:</span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>      <span class="in">```python</span></span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a>      sensor <span class="op">=</span> create_sensor(sensor_config, <span class="va">self</span>.vessel_id, <span class="va">self</span>.topic_prefix, <span class="va">self</span>)</span>
<span id="cb24-710"><a href="#cb24-710" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.sensors.append({</span>
<span id="cb24-711"><a href="#cb24-711" aria-hidden="true" tabindex="-1"></a>          <span class="st">'sensor'</span>: sensor,</span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a>          <span class="st">'pub'</span>: <span class="va">self</span>.world_node.create_publisher(<span class="va">self</span>._get_msg_type(sensor.sensor_type), sensor_topic, <span class="dv">10</span>),</span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a>          <span class="st">'timer'</span>: <span class="va">self</span>.world_node.create_timer(<span class="dv">1</span><span class="op">/</span>sensor.rate, <span class="kw">lambda</span> s<span class="op">=</span>sensor: <span class="va">self</span>._publish_sensor(s))</span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a>      <span class="in">```</span></span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a><span class="ss">12. </span>**StartVessels to SpinThread**:</span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span><span class="in">`threading.Thread(target=ros_thread, args=(world_node,))`</span> is created and started</span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>This runs <span class="in">`rclpy.spin(node)`</span> in a separate thread</span>
<span id="cb24-720"><a href="#cb24-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-721"><a href="#cb24-721" aria-hidden="true" tabindex="-1"></a><span class="ss">13. </span>**SpinThread to PrintInfo**:</span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>Available ROS2 topics are listed and helpful usage information is printed</span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a>Key steps in this process:</span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The simulation begins in <span class="in">`simulate.py`</span></span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>ROS2 is initialized</span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>A World object is created from the input configuration file</span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>A World_Node is created and linked to the World object</span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Vessel ROS nodes are started for each vessel in the world</span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>For each vessel, a Vessel_Pub_Sub object is created, which:</span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Sets up publishers for odometry and vessel state</span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Sets up subscribers for actuator commands</span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Creates sensor objects based on the vessel configuration</span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Sets up timers for publishing sensor data</span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-737"><a href="#cb24-737" aria-hidden="true" tabindex="-1"></a><span class="fu">## Running the Simulation</span></span>
<span id="cb24-738"><a href="#cb24-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-739"><a href="#cb24-739" aria-hidden="true" tabindex="-1"></a>To run the MAV simulator with ROS2 integration:</span>
<span id="cb24-740"><a href="#cb24-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-741"><a href="#cb24-741" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb24-742"><a href="#cb24-742" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to the workspace</span></span>
<span id="cb24-743"><a href="#cb24-743" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /path/to/makara</span>
<span id="cb24-744"><a href="#cb24-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-745"><a href="#cb24-745" aria-hidden="true" tabindex="-1"></a><span class="co"># Build ROS2 packages</span></span>
<span id="cb24-746"><a href="#cb24-746" aria-hidden="true" tabindex="-1"></a><span class="ex">colcon</span> build</span>
<span id="cb24-747"><a href="#cb24-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-748"><a href="#cb24-748" aria-hidden="true" tabindex="-1"></a><span class="co"># Source the workspace</span></span>
<span id="cb24-749"><a href="#cb24-749" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> install/setup.bash</span>
<span id="cb24-750"><a href="#cb24-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-751"><a href="#cb24-751" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulator</span></span>
<span id="cb24-752"><a href="#cb24-752" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> run mav_simulator simulate</span>
<span id="cb24-753"><a href="#cb24-753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-754"><a href="#cb24-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-755"><a href="#cb24-755" aria-hidden="true" tabindex="-1"></a>After starting the simulation, you can interact with it using standard ROS2 commands:</span>
<span id="cb24-756"><a href="#cb24-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-757"><a href="#cb24-757" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb24-758"><a href="#cb24-758" aria-hidden="true" tabindex="-1"></a><span class="co"># List all available topics</span></span>
<span id="cb24-759"><a href="#cb24-759" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic list</span>
<span id="cb24-760"><a href="#cb24-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-761"><a href="#cb24-761" aria-hidden="true" tabindex="-1"></a><span class="co"># Subscribe to vessel odometry</span></span>
<span id="cb24-762"><a href="#cb24-762" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic echo /<span class="op">&lt;</span>vessel_name<span class="op">&gt;</span>_<span class="op">&lt;</span>id<span class="op">&gt;</span>/odometry_sim</span>
<span id="cb24-763"><a href="#cb24-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-764"><a href="#cb24-764" aria-hidden="true" tabindex="-1"></a><span class="co"># Publish control commands</span></span>
<span id="cb24-765"><a href="#cb24-765" aria-hidden="true" tabindex="-1"></a><span class="ex">ros2</span> topic pub /<span class="op">&lt;</span>vessel_name<span class="op">&gt;</span>_<span class="op">&lt;</span>id<span class="op">&gt;</span>/actuator_cmd interfaces/Actuator <span class="dt">\</span></span>
<span id="cb24-766"><a href="#cb24-766" aria-hidden="true" tabindex="-1"></a><span class="st">"{header: {stamp: {sec: 0}}, actuator_names: ['cs_1', 'th_1'], actuator_values: [15.0, 1200.0]}"</span></span>
<span id="cb24-767"><a href="#cb24-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-768"><a href="#cb24-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-769"><a href="#cb24-769" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Practices</span></span>
<span id="cb24-770"><a href="#cb24-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-771"><a href="#cb24-771" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Launch Files**: Create launch files for different simulation scenarios. There are some example launch files in the <span class="in">`/workspace/mavlab/ros2_ws/src/mav_simulator/mav_simulator/launch`</span> folder.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/goldenrishabh/panisim/edit/main/rawFiles/ROS2/ros2.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/goldenrishabh/panisim/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>